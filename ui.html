<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>LLM Canvas Demo</title>
    <style>
      :root {
        --bg: #111318;
        --panel: #171a21;
        --panel-strong: #1c1f26;
        --panel-border: #2a2f36;
        --text: #e8ecf3;
        --text-dim: #b7becd;
        --muted: #7c8391;
        --accent: #c7ff3a;
        --accent-weak: #d8ff7a;
        --stroke: #2f3440;
        --surface-hover: rgba(255, 255, 255, 0.02);
        --surface-press: rgba(255, 255, 255, 0.04);
        --shadow: 0 12px 30px rgba(0, 0, 0, 0.45);
        --radius-sm: 8px;
        --radius: 12px;
      }
      * {
        box-sizing: border-box;
      }
      body {
        font-family: 'Inter', 'SF Pro Text', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI',
          sans-serif;
        margin: 0;
        padding: 16px;
        font-size: 12px;
        background: var(--bg);
        color: var(--text);
      }
      label {
        display: block;
        margin-bottom: 4px;
        font-weight: 600;
        color: var(--text);
      }
      input,
      select,
      textarea {
        width: 100%;
        box-sizing: border-box;
        padding: 6px 8px;
        font-size: 12px;
        border-radius: var(--radius-sm);
        border: 1px solid var(--panel-border);
        background: var(--panel);
        color: var(--text);
      }
      input:focus,
      select:focus,
      textarea:focus {
        outline: 1px solid var(--accent);
        box-shadow: 0 0 0 3px rgba(199, 255, 58, 0.1);
        border-color: var(--accent);
      }
      button {
        margin-top: 8px;
        padding: 8px 10px;
        border-radius: var(--radius-sm);
        border: 1px solid var(--panel-border);
        background: var(--panel);
        color: var(--text);
        cursor: pointer;
        transition: all 0.15s ease;
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.02);
      }
      button:hover {
        background: var(--surface-hover);
        border-color: var(--stroke);
      }
      button:active {
        background: var(--surface-press);
        transform: translateY(1px);
      }
      button.primary {
        background: var(--accent);
        color: #0f1116;
        border-color: var(--accent-weak);
        box-shadow: 0 8px 16px rgba(199, 255, 58, 0.25);
      }
      button.primary:hover {
        filter: brightness(1.05);
      }
      button.primary:active {
        filter: brightness(0.97);
      }
      .row {
        display: flex;
        gap: 8px;
      }
      .row button {
        width: auto;
        margin-top: 0;
      }
      .lib {
        margin-top: 8px;
        border: 1px solid var(--panel-border);
        border-radius: var(--radius);
        padding: 8px;
        background: var(--panel);
        box-shadow: var(--shadow);
      }
      .lib-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 4px;
        font-weight: 600;
      }
      .lib-header button {
        width: auto;
        margin-top: 0;
        padding: 4px 8px;
      }
      .lib-header .right {
        display: flex;
        gap: 6px;
      }
      .meta-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 6px;
        margin-top: 4px;
      }
      .meta-grid textarea {
        height: 50px;
        font-size: 12px;
      }
      .tag-input,
      .meta-input {
        width: 100%;
        box-sizing: border-box;
        font-size: 12px;
        padding: 6px 8px;
        border-radius: var(--radius-sm);
        border: 1px solid var(--panel-border);
        background: var(--panel);
        color: var(--text);
      }
      .chip-row {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
      }
      .chip {
        border: 1px solid var(--panel-border);
        border-radius: 4px;
        padding: 2px 6px;
        font-size: 11px;
        background: #1f2330;
        cursor: pointer;
        color: var(--text);
      }
      .chip.selected {
        background: rgba(199, 255, 58, 0.12);
        border-color: var(--accent);
      }
      .slot-panel {
        margin-top: 8px;
        border: 1px solid var(--panel-border);
        border-radius: var(--radius);
        padding: 8px;
        background: var(--panel);
      }
      .slot-grid {
        display: grid;
        grid-template-columns: 1.3fr 140px 140px 180px;
        gap: 6px;
        align-items: center;
      }
      .slot-header {
        font-weight: 600;
        margin-bottom: 6px;
      }
      .slot-row {
        font-size: 12px;
      }
      .slot-summary {
        font-size: 12px;
        color: var(--text);
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .slot-hint {
        font-size: 11px;
        color: var(--muted);
        margin: 4px 0;
      }
      .slot-filter {
        width: 100%;
        box-sizing: border-box;
        margin: 6px 0;
        padding: 6px 8px;
        font-size: 12px;
      }
      .badge {
        display: inline-block;
        padding: 2px 6px;
        font-size: 11px;
        border-radius: 4px;
        border: 1px solid var(--panel-border);
        background: #1f2330;
        color: var(--text);
      }
      .badge.accent {
        border-color: var(--accent);
        background: rgba(199, 255, 58, 0.15);
      }
      .badge.ghost {
        background: var(--panel);
      }
      .lib-list {
        max-height: 220px;
        overflow: auto;
        display: grid;
        gap: 6px;
      }
      .lib-list.compact {
        max-height: 500px;
        grid-template-columns: 1fr;
      }
      .lib-tile {
        border: 1px solid var(--panel-border);
        border-radius: var(--radius-sm);
        padding: 8px;
        background: var(--panel);
        cursor: pointer;
        transition: all 0.12s ease;
      }
      .lib-tile:hover {
        border-color: var(--stroke);
        background: var(--surface-hover);
      }
      .lib-tile.active {
        border-color: var(--accent);
        background: rgba(199, 255, 58, 0.08);
        box-shadow: var(--shadow);
      }
      .lib-tile .title-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 600;
        color: var(--text);
      }
      .lib-tile .meta-row {
        margin-top: 4px;
        font-size: 11px;
        color: var(--muted);
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
      }
      .filter-row {
        margin: 6px 0;
      }
      .lib-item {
        border: 1px solid var(--panel-border);
        border-radius: var(--radius);
        padding: 10px;
        background: var(--panel-strong);
        box-shadow: var(--shadow);
      }
      .lib-meta {
        font-size: 11px;
        color: var(--muted);
        margin-top: 2px;
      }
      .detail-wrap {
        border: 1px solid var(--panel-border);
        border-radius: var(--radius);
        background: var(--panel-strong);
        padding: 10px;
        min-height: 320px;
      }
      .detail-section {
        margin-top: 8px;
        padding: 8px;
        border: 1px solid var(--panel-border);
        border-radius: var(--radius-sm);
        background: #141821;
      }
      .detail-section h4 {
        margin: 0 0 6px 0;
        font-size: 12px;
      }
      .empty {
        color: var(--muted);
        text-align: center;
        padding: 40px 0;
      }
      .lib-note {
        margin-top: 4px;
        font-size: 12px;
        width: 100%;
      }
      .lib-actions {
        text-align: right;
      }
      .status {
        margin-top: 6px;
        min-height: 16px;
        color: var(--text);
      }
      .op-list {
        margin-top: 6px;
        border: 1px solid var(--panel-border);
        border-radius: var(--radius);
        padding: 6px;
        background: var(--panel);
        font-size: 11px;
        max-height: 140px;
        overflow: auto;
      }
      .op-item {
        padding: 2px 0;
        border-bottom: 1px solid var(--stroke);
      }
      .op-item:last-child {
        border-bottom: none;
      }
      .tab-shell {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .tab-panel {
        display: none;
      }
      .tab-panel.active {
        display: block;
      }
      .stepper {
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: 10px;
        margin-top: 4px;
      }
      .step-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 12px;
        border-radius: var(--radius);
        border: 1px solid var(--panel-border);
        background: var(--panel-strong);
        color: var(--text);
        cursor: pointer;
        transition: all 0.15s ease;
      }
      .step-btn .dot {
        width: 18px;
        height: 18px;
        border-radius: 999px;
        border: 2px solid var(--accent);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        color: var(--accent);
      }
      .step-btn.active {
        border-color: var(--accent);
        box-shadow: var(--shadow);
        color: var(--accent);
      }
      .grid-2 {
        display: grid;
        grid-template-columns: 1fr 2fr;
        gap: 12px;
      }
      .grid-2-1 {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 12px;
      }
      .card {
        border: 1px solid var(--panel-border);
        border-radius: var(--radius);
        background: var(--panel-strong);
        padding: 12px;
        box-shadow: var(--shadow);
      }
      .card h3 {
        margin: 0 0 8px 0;
        font-size: 14px;
      }
      .section-title {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 8px;
      }
      .pill-ghost {
        padding: 4px 8px;
        border-radius: 999px;
        background: var(--surface-hover);
        color: var(--muted);
        font-size: 11px;
      }
      .floating-exp {
        position: fixed;
        left: 16px;
        bottom: 16px;
        padding: 10px 14px;
        border-radius: 999px;
        border: 1px solid var(--panel-border);
        background: var(--panel-strong);
        color: var(--text);
        box-shadow: var(--shadow);
        cursor: pointer;
      }
      .floating-exp:hover {
        border-color: var(--accent);
        color: var(--accent);
      }
      .modal {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 20;
      }
      .modal.active {
        display: flex;
      }
      .modal-backdrop {
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.55);
      }
      .modal-card {
        position: relative;
        width: 560px;
        max-height: 80vh;
        overflow: auto;
        background: var(--panel-strong);
        border: 1px solid var(--panel-border);
        border-radius: var(--radius);
        padding: 14px;
        box-shadow: var(--shadow);
        z-index: 21;
      }
      .close-btn {
        border: none;
        background: transparent;
        color: var(--text);
        font-size: 16px;
        padding: 0 6px;
        cursor: pointer;
      }
      .req-grid {
        display: grid;
        grid-template-columns: 1fr 2fr;
        gap: 6px;
      }
      .detail-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 6px;
        margin-top: 6px;
      }
      .detail-label {
        font-size: 11px;
        color: var(--muted);
        margin-bottom: 2px;
      }
      .readonly-box {
        border: 1px solid var(--panel-border);
        border-radius: 4px;
        padding: 4px 6px;
        background: #151821;
        font-size: 11px;
        color: var(--text);
      }
      .exp-list {
        display: grid;
        gap: 6px;
        margin-top: 6px;
      }
      .preview-box {
        position: relative;
        width: 100%;
        max-width: 420px;
        aspect-ratio: 16 / 9;
        border: 1px dashed var(--stroke);
        border-radius: var(--radius);
        background: #131621;
        overflow: hidden;
        margin-top: 8px;
      }
      .preview-region {
        position: absolute;
        border: 1px solid #6b7280;
        background: rgba(148, 163, 184, 0.12);
        border-radius: 6px;
        font-size: 10px;
        color: #e5e7eb;
        padding: 4px;
        box-sizing: border-box;
        overflow: hidden;
      }
      .preview-region strong {
        display: block;
        margin-bottom: 2px;
        font-size: 11px;
      }
      .template-preview {
        margin-top: 8px;
        width: 100%;
        aspect-ratio: 16 / 9;
        border: 1px dashed var(--stroke);
        border-radius: var(--radius-sm);
        background: #0f121a;
        position: relative;
        overflow: hidden;
      }
      .tp-row {
        position: absolute;
        background: rgba(199, 255, 58, 0.08);
        border: 1px solid rgba(199, 255, 58, 0.4);
        border-radius: 6px;
      }
      .exp-item {
        border: 1px solid var(--panel-border);
        border-radius: var(--radius);
        padding: 8px;
        background: var(--panel);
        display: grid;
        grid-template-columns: 18px 1fr;
        gap: 8px;
        align-items: flex-start;
      }
      .exp-title {
        font-weight: 600;
      }
      .exp-desc {
        font-size: 11px;
        color: var(--muted);
        margin-top: 2px;
      }
      .exp-meta {
        font-size: 11px;
        color: var(--muted);
        margin-top: 2px;
      }
      .exp-empty {
        color: var(--muted);
        font-size: 12px;
        border: 1px dashed var(--panel-border);
        background: #151821;
        padding: 8px;
        border-radius: var(--radius);
      }
      .req-list {
        max-height: 220px;
        overflow: auto;
        border: 1px solid var(--panel-border);
        border-radius: var(--radius);
        background: var(--panel);
      }
      .req-item {
        padding: 6px;
        border-bottom: 1px solid var(--stroke);
        cursor: pointer;
      }
      .req-item:hover {
        background: var(--surface-hover);
      }
      .req-item.active {
        background: rgba(199, 255, 58, 0.08);
        border-left: 2px solid var(--accent);
      }
      .pill {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 11px;
        background: #1f2330;
        margin-right: 4px;
      }
      .priority-list {
        max-height: 220px;
        overflow: auto;
        border: 1px solid var(--panel-border);
        border-radius: var(--radius);
        background: var(--panel);
        padding: 6px;
      }
      .priority-row {
        display: grid;
        grid-template-columns: 48px 1fr 2fr 1fr;
        gap: 6px;
        align-items: center;
        padding: 6px 0;
        border-bottom: 1px solid var(--stroke);
      }
      .priority-row:last-child {
        border-bottom: none;
      }
      .small-input {
        width: 100%;
        box-sizing: border-box;
        font-size: 12px;
        padding: 6px 8px;
      }
      .export-block {
        margin-top: 6px;
        display: none;
      }
      .export-block textarea {
        width: 100%;
        box-sizing: border-box;
        height: 100px;
        font-size: 11px;
      }
      .section {
        margin-top: 10px;
        padding: 10px;
        border: 1px solid var(--panel-border);
        border-radius: var(--radius);
        background: var(--panel-strong);
        box-shadow: var(--shadow);
      }
      .section h3 {
        margin: 0 0 6px 0;
        font-size: 13px;
      }
      .summary {
        font-size: 11px;
        color: var(--muted);
      }
      .summary span {
        display: inline-block;
        margin-right: 8px;
      }
      .two-col {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }
      textarea.small {
        height: 80px;
      }
      .status {
        margin-top: 6px;
        min-height: 16px;
        color: var(--text);
      }
    </style>
  </head>
  <body>
    <div class="tab-shell">
      <div class="stepper">
        <button class="step-btn active" data-tab="libraryTab">
          <span class="dot">1</span><span>导入/管理组件库</span>
        </button>
        <button class="step-btn" data-tab="requirementTab">
          <span class="dot">2</span><span>解析需求与绑定</span>
        </button>
        <button class="step-btn" data-tab="layoutTab">
          <span class="dot">3</span><span>布局与生成</span>
        </button>
        <button class="step-btn" data-tab="editTab">
          <span class="dot">4</span><span>编辑微调</span>
        </button>
      </div>

      <div id="libraryTab" class="tab-panel active">
        <div class="grid-2">
          <div class="card">
            <div class="section-title">
              <h3>组件库</h3>
              <span class="pill-ghost">Step 1</span>
            </div>
            <div class="lib-header" style="gap: 6px; flex-wrap: wrap">
              <button id="import">导入选中 Section</button>
              <button id="enrich">AI 推荐元数据</button>
              <button id="export">导出 JSON</button>
            </div>
            <div class="filter-row row" style="align-items: center">
              <input id="librarySearch" type="search" placeholder="搜索名称/标签" style="flex: 1" />
              <select id="librarySort" style="width: 140px">
                <option value="updated">最近更新</option>
                <option value="name">名称 A-Z</option>
                <option value="size">尺寸（大到小）</option>
              </select>
            </div>
            <div id="library-list" class="lib-list compact"></div>
            <div id="exportWrap" class="export-block">
              <div class="row" style="justify-content: space-between; align-items: center">
                <span class="summary">已生成 JSON，可复制</span>
                <button id="copyExport">复制</button>
              </div>
              <textarea id="exportText" readonly></textarea>
            </div>
          </div>
          <div class="card">
            <div class="section-title">
              <h3>组件详情</h3>
              <span class="pill-ghost">编辑 / 插槽</span>
            </div>
            <div id="libraryDetail" class="detail-wrap">
              <div class="empty">在左侧选择组件以查看详情</div>
            </div>
            <div class="row" style="margin-top: 10px; justify-content: flex-end">
              <button id="goRequirement" class="primary" style="width: auto">下一步：需求解析</button>
            </div>
          </div>
        </div>
      </div>

      <div id="requirementTab" class="tab-panel">
        <div class="grid-2">
          <div class="card">
            <div class="section-title">
              <h3>需求文档</h3>
              <span class="pill-ghost">Step 2</span>
            </div>
            <textarea
              id="docText"
              class="small"
              placeholder="粘贴需求文档，用于解析阶段/角色/信息项/页面"
            ></textarea>
            <div class="row" style="margin-top: 6px; align-items: center">
              <button id="parseDoc" class="primary" style="width: auto">解析文档</button>
            </div>
            <div class="detail-section">
              <h4>解析概览</h4>
              <div class="summary" id="reqStats"></div>
            </div>
            <div class="detail-section">
              <h4>阶段 / 角色 / 条件 / 信息项</h4>
              <div class="req-grid">
                <div>
                  <div class="summary">阶段</div>
                  <div id="phaseList" class="req-list"></div>
                </div>
                <div>
                  <div class="summary">角色</div>
                  <div id="roleList" class="req-list"></div>
                </div>
                <div>
                  <div class="summary">条件</div>
                  <div id="conditionList" class="req-list"></div>
                </div>
                <div>
                  <div class="summary">信息项</div>
                  <div id="infoItemList" class="req-list"></div>
                </div>
              </div>
            </div>
          </div>
          <div class="card">
            <div class="section-title">
              <h3>解析结果（单页优先级）</h3>
              <span class="pill-ghost">排序 / 编辑</span>
            </div>
            <div class="req-grid">
              <div>
                <div class="summary">页面列表（单选）</div>
                <div id="pageListSingle" class="req-list"></div>
              </div>
              <div>
                <div class="summary">信息项优先级（选中页面）</div>
                <div id="pageInfoSingle" class="priority-list"></div>
              </div>
            </div>
            <div class="row" style="justify-content: flex-end; margin-top: 6px">
              <button id="saveRequirement" style="width: auto">保存解析结果</button>
            </div>
            <div class="summary" style="margin-top: 6px">
              <span>高优先级 ≤ 1 项</span>
              <span style="margin-left: 8px">中优先级 ≤ 4 项</span>
            </div>
          </div>
        </div>
      </div>

      <div id="layoutTab" class="tab-panel">
        <div class="card">
          <div class="section-title">
            <h3>解析结果（只读 / 绑定组件）</h3>
            <span class="pill-ghost">页面 & 信息项</span>
          </div>
          <div class="req-grid">
            <div>
              <div class="summary">页面列表（可多选）</div>
              <div id="pageListBinding" class="req-list"></div>
            </div>
            <div>
              <div class="summary">信息项优先级（只读）</div>
              <div id="pageInfoBinding" class="priority-list"></div>
            </div>
          </div>
          <div class="row" style="justify-content: flex-end; margin-top: 6px; gap: 6px">
            <button id="recommendBindings" style="width: auto">AI 推荐组件</button>
            <button id="saveRequirementBinding" style="width: auto">保存绑定</button>
          </div>
        </div>
        <div class="grid-2-1" style="margin-top: 10px">
          <div class="card">
            <div class="section-title">
              <h3>布局与生成</h3>
              <span class="pill-ghost">Step 3</span>
            </div>
            <div class="summary" id="layoutHint"></div>
            <div class="row" style="gap: 8px; margin: 6px 0;">
              <label style="display:flex;align-items:center;gap:4px;">
                <input type="radio" name="layoutModeInner" value="smart" checked />
                智能布局草案
              </label>
              <label style="display:flex;align-items:center;gap:4px;">
                <input type="radio" name="layoutModeInner" value="template" />
                基础模板
              </label>
            </div>
            <div id="smartBlock">
              <div class="two-col" style="margin-top: 6px">
                <div>
                  <label>屏幕类型</label>
                  <select id="screenType">
                    <option value="dashboard">通用仪表盘</option>
                    <option value="factory">工厂总览</option>
                    <option value="hud">飞行 HUD</option>
                    <option value="ops">运维监控</option>
                  </select>
                </div>
                <div>
                  <label>提示</label>
                  <div class="summary">基于已选页面 + 组件绑定生成智能草案</div>
                </div>
              </div>
              <div class="two-col" style="margin-top: 6px">
                <div>
                  <label>背景（选中节点作为背景，选填）</label>
                  <div class="row" style="gap: 6px; align-items: center">
                    <button id="pickBackgroundBtn" style="width: auto">使用选中节点</button>
                    <span id="backgroundPreview" class="summary"></span>
                  </div>
                </div>
                <div>
                  <label>布局操作</label>
                  <div class="row" style="gap: 6px">
                    <button id="generatePlanBtn" style="width: auto">生成布局草案</button>
                    <button id="applyPlanBtn" class="primary" style="width: auto">生成到画布</button>
                  </div>
                  <div id="layoutPlanStatus" class="summary"></div>
                </div>
              </div>
              <div id="layoutPreview" class="preview-box"></div>
            </div>
            <div id="templateBlock" style="display:none; margin-top: 8px;">
              <label>基础模板</label>
              <select id="templateSelect">
                <option value="two-col">双列</option>
                <option value="three-col">三列</option>
                <option value="main-side">主+侧</option>
                <option value="dashboard">仪表盘</option>
              </select>
              <button id="generatePages" class="primary" style="margin-top: 8px; width: 100%">生成所选页面</button>
              <div id="templatePreview" class="template-preview"></div>
              <div class="summary">无组件绑定时将使用占位组件</div>
            </div>
          </div>

          <div class="card">
            <div class="section-title">
              <h3>LLM 自由生成（新页面）</h3>
              <span class="pill-ghost">页面生成</span>
            </div>
            <div>
              <label>模型提供商</label>
              <select id="provider">
                <option value="siliconflow">SiliconFlow（OpenAI兼容）</option>
                <option value="openai">OpenAI</option>
                <option value="gemini">Gemini</option>
              </select>
            </div>
            <div style="margin-top: 8px">
              <label>指令（自然语言）</label>
              <textarea
                id="prompt"
                rows="3"
                placeholder="例如：生成“姿态监控-正常飞行”页面"
              ></textarea>
            </div>
            <div class="row" style="align-items: center; margin-top: 8px">
              <label style="margin: 0; display: flex; align-items: center; gap: 4px">
                <input id="useLibrary" type="checkbox" checked />
                生成时参考组件库
              </label>
              <button id="run" class="primary" style="width: auto">生成到画布</button>
            </div>
            <div id="status" class="status"></div>
          </div>
        </div>
      </div>

      <div id="editTab" class="tab-panel">
        <div class="card">
          <div class="section-title">
            <h3>UI 编辑（单页面）</h3>
            <span class="pill-ghost">Step 4</span>
          </div>
          <div class="summary">先在画布选中要编辑的 Frame，然后输入自然语言指令</div>
          <div class="two-col" style="margin-top: 6px">
            <div>
              <label>模型提供商</label>
              <select id="editProvider">
                <option value="siliconflow">SiliconFlow（OpenAI兼容）</option>
                <option value="openai">OpenAI</option>
                <option value="gemini">Gemini</option>
              </select>
            </div>
            <div>
              <label>API Key（可选）</label>
              <input id="editApiKey" type="password" placeholder="留空则使用服务端配置" />
            </div>
          </div>
          <label style="margin-top: 6px; display: block">编辑指令</label>
          <textarea
            id="editPrompt"
            rows="3"
            placeholder="例如：把过滤条调整到顶部，并增加一个两列布局的告警摘要卡片"
          ></textarea>
          <div class="row" style="margin-top: 8px; justify-content: space-between; align-items: center">
            <button id="applyEdit" class="primary" style="width: auto">应用到所选页面</button>
            <button id="undoEdit" style="width: auto">撤销上一次编辑</button>
          </div>
          <div id="editStatus" class="status"></div>
          <div id="editOpsList" class="op-list"></div>
        </div>
      </div>
    </div>
    <button id="openExperiment" class="floating-exp">实验预设</button>
    <div id="experimentModal" class="modal">
      <div class="modal-backdrop"></div>
      <div class="modal-card">
        <div class="section-title" style="align-items: center">
          <h3 style="margin: 0">实验模式</h3>
          <div class="row" style="gap: 6px; align-items: center">
            <span class="pill-ghost">预设场景</span>
            <button id="closeExperiment" class="close-btn">×</button>
          </div>
        </div>
        <div class="summary">选择预设场景，一键加载需求模型与组件库</div>
        <div id="experimentList" class="exp-list"></div>
        <div class="row" style="margin-top: 8px; justify-content: space-between; align-items: center">
          <div id="experimentStatus" class="summary"></div>
          <button id="loadExperimentBtn" class="primary" style="width: auto">加载场景</button>
        </div>
      </div>
    </div>
    <script>
      const runButton = document.getElementById('run');
      const statusEl = document.getElementById('status');
      const importBtn = document.getElementById('import');
      const exportBtn = document.getElementById('export');
      const enrichBtn = document.getElementById('enrich');
      const libraryListEl = document.getElementById('library-list');
      const librarySearchEl = document.getElementById('librarySearch');
      const librarySortEl = document.getElementById('librarySort');
      const libraryDetailEl = document.getElementById('libraryDetail');
      const useLibraryEl = document.getElementById('useLibrary');
      const docTextEl = document.getElementById('docText');
      const parseDocBtn = document.getElementById('parseDoc');
      const reqStatsEl = document.getElementById('reqStats');
      const phaseListEl = document.getElementById('phaseList');
      const roleListEl = document.getElementById('roleList');
      const conditionListEl = document.getElementById('conditionList');
      const infoItemListEl = document.getElementById('infoItemList');
      const providerEl = document.getElementById('provider');
      const promptEl = document.getElementById('prompt');
      const screenTypeEl = document.getElementById('screenType');
      const layoutHintEl = document.getElementById('layoutHint');
      const smartBlock = document.getElementById('smartBlock');
      const templateBlock = document.getElementById('templateBlock');
      const templatePreviewEl = document.getElementById('templatePreview');
      const layoutModeInnerRadios = Array.from(document.querySelectorAll('input[name=\"layoutModeInner\"]'));
      const pickBackgroundBtn = document.getElementById('pickBackgroundBtn');
      const backgroundPreviewEl = document.getElementById('backgroundPreview');
      const layoutPlanStatusEl = document.getElementById('layoutPlanStatus');
      const layoutPreviewEl = document.getElementById('layoutPreview');
      const generatePlanBtn = document.getElementById('generatePlanBtn');
      const applyPlanBtn = document.getElementById('applyPlanBtn');
      const exportWrap = document.getElementById('exportWrap');
      const exportText = document.getElementById('exportText');
      const copyExportBtn = document.getElementById('copyExport');
      const pageListSingleEl = document.getElementById('pageListSingle');
      const pageInfoSingleEl = document.getElementById('pageInfoSingle');
      const pageListBindingEl = document.getElementById('pageListBinding');
      const pageInfoBindingEl = document.getElementById('pageInfoBinding');
      const saveReqBtn = document.getElementById('saveRequirement');
      const saveReqBindingBtn = document.getElementById('saveRequirementBinding');
      const recommendBtn = document.getElementById('recommendBindings');
      const templateSelect = document.getElementById('templateSelect');
      const generatePagesBtn = document.getElementById('generatePages');
      const editPromptEl = document.getElementById('editPrompt');
      const editProviderEl = document.getElementById('editProvider');
      const editApiKeyEl = document.getElementById('editApiKey');
      const applyEditBtn = document.getElementById('applyEdit');
      const undoEditBtn = document.getElementById('undoEdit');
      const editStatusEl = document.getElementById('editStatus');
      const editOpsList = document.getElementById('editOpsList');
      const stepButtons = Array.from(document.querySelectorAll('.step-btn'));
      const tabPanels = {
        libraryTab: document.getElementById('libraryTab'),
        requirementTab: document.getElementById('requirementTab'),
        layoutTab: document.getElementById('layoutTab'),
        editTab: document.getElementById('editTab')
      };
      const goRequirementBtn = document.getElementById('goRequirement');
      const experimentListEl = document.getElementById('experimentList');
      const loadExperimentBtn = document.getElementById('loadExperimentBtn');
      const experimentStatusEl = document.getElementById('experimentStatus');
      const openExperimentBtn = document.getElementById('openExperiment');
      const closeExperimentBtn = document.getElementById('closeExperiment');
      const experimentModal = document.getElementById('experimentModal');
      let library = [];
      let requirement = null;
      let experiments = [];
      let slotState = null;
      let slotFilter = '';
      let selectedPageIdSingle = null;
      const selectedPageIds = new Set();
      let selectedBindingPageId = null;
      let layoutModeInner = 'smart';
      let selectedExperimentId = null;
      let experimentLoading = false;
      let loadedExperimentName = '';
      const DATA_TYPES = ['numeric', 'trend', 'alert', 'state', 'text', 'map', 'list'];
      const SLOT_TYPES = ['label', 'numericValue', 'unit', 'state', 'alert', 'listItem'];
      const INFO_CATEGORIES = ['status', 'metric', 'trend', 'alert', 'navigation', 'context', 'control', 'composite'];
      const TASK_STAGES = ['overview', 'monitoring', 'drilldown', 'investigation', 'recovery'];
      const PRIORITY_AFFINITIES = ['high', 'medium', 'low', 'flexible'];
      const CRITICALITY_OPTIONS = ['good', 'limited', 'not-suitable'];
      const VISUAL_FOOTPRINTS = ['small', 'medium', 'large'];
      const DENSITY_PROFILES = ['sparse', 'normal', 'dense'];
      const DYNAMIC_BEHAVIORS = ['static', 'frequent-update', 'event-driven'];
      const LAYOUT_ROLES = ['hero', 'summary', 'sidebar', 'toolbar', 'inline'];
      const VIEWPORT_ZONES = ['top-left', 'top', 'center', 'bottom', 'any'];
      let layoutPlan = null;
      let backgroundNodeId = null;
      let selectedComponentId = null;
      if (applyPlanBtn) applyPlanBtn.disabled = true;

      const updateComponentMeta = (id, payload) => {
        parent.postMessage({ pluginMessage: { type: 'update-component-meta', id, ...payload } }, '*');
      };

      const parseListInput = (value) =>
        Array.from(
          new Set(
            (value || '')
              .split(',')
              .map((v) => v.trim())
              .filter(Boolean)
          )
        );

      const createBadge = (label, value) => {
        const badge = document.createElement('span');
        badge.className = 'badge';
        badge.textContent = `${label}:${value || '未设定'}`;
        return badge;
      };

      const setLoading = (isLoading) => {
        runButton.disabled = isLoading;
        runButton.textContent = isLoading ? '生成中…' : '生成到画布';
        if (isLoading) {
          statusEl.textContent = '正在生成，请稍候…';
        } else if (statusEl.dataset.state !== 'success') {
          statusEl.textContent = '';
        }
        statusEl.dataset.state = isLoading ? 'loading' : statusEl.dataset.state;
      };

      const setEditLoading = (isLoading) => {
        applyEditBtn.disabled = isLoading;
        undoEditBtn.disabled = isLoading;
        if (isLoading) {
          editStatusEl.textContent = '正在生成编辑方案…';
          editStatusEl.dataset.state = 'loading';
        }
      };

      const setExperimentLoading = (isLoading) => {
        experimentLoading = isLoading;
        if (loadExperimentBtn) {
          loadExperimentBtn.disabled = isLoading || !selectedExperimentId;
          loadExperimentBtn.textContent = isLoading ? '加载中…' : '加载场景';
        }
      };

      const renderExperiments = () => {
        if (!experimentListEl) return;
        experimentListEl.innerHTML = '';
        if (!experiments.length) {
          const empty = document.createElement('div');
          empty.className = 'exp-empty';
          empty.textContent = '当前无可用实验场景';
          experimentListEl.appendChild(empty);
          if (loadExperimentBtn) loadExperimentBtn.disabled = true;
          return;
        }
        if (!selectedExperimentId) {
          selectedExperimentId = experiments[0].id;
        }
        experiments.forEach((exp) => {
          const row = document.createElement('label');
          row.className = 'exp-item';
          const radio = document.createElement('input');
          radio.type = 'radio';
          radio.name = 'experiment';
          radio.value = exp.id;
          radio.checked = exp.id === selectedExperimentId;
          radio.onchange = () => {
            selectedExperimentId = exp.id;
            setExperimentLoading(false);
            renderExperiments();
          };

          const body = document.createElement('div');
          const title = document.createElement('div');
          title.className = 'exp-title';
          title.textContent = exp.name || exp.id;
          const desc = document.createElement('div');
          desc.className = 'exp-desc';
          desc.textContent = exp.description || '无描述';
          const meta = document.createElement('div');
          meta.className = 'exp-meta';
          meta.textContent = `ID: ${exp.id}`;
          body.appendChild(title);
          body.appendChild(desc);
          body.appendChild(meta);

          row.appendChild(radio);
          row.appendChild(body);
          experimentListEl.appendChild(row);
        });
        if (loadExperimentBtn) {
          loadExperimentBtn.disabled = experimentLoading || !selectedExperimentId;
          loadExperimentBtn.textContent = experimentLoading ? '加载中…' : '加载场景';
        }
        if (experimentStatusEl && loadedExperimentName) {
          experimentStatusEl.textContent = `已加载：${loadedExperimentName}`;
        }
      };

      const renderLayoutPreview = (plan) => {
        if (!layoutPreviewEl) return;
        layoutPreviewEl.innerHTML = '';
        if (!plan || !Array.isArray(plan.regions)) {
          layoutPreviewEl.textContent = '暂无布局方案';
          return;
        }
        plan.regions.forEach((region) => {
          const div = document.createElement('div');
          div.className = 'preview-region';
          div.style.left = `${region.x * 100}%`;
          div.style.top = `${region.y * 100}%`;
          div.style.width = `${region.width * 100}%`;
          div.style.height = `${region.height * 100}%`;
          div.innerHTML = `<strong>${region.name || region.id}</strong>${(region.items || [])
            .slice(0, 3)
            .map((it) => it.infoItemId)
            .join(' · ')}`;
          layoutPreviewEl.appendChild(div);
        });
      };

      const renderEditOps = (ops = [], summary = '') => {
        if (!editOpsList) return;
        editOpsList.innerHTML = '';
        if (summary) {
          const s = document.createElement('div');
          s.className = 'op-item';
          s.textContent = summary;
          editOpsList.appendChild(s);
        }
        if (!ops.length && !summary) {
          editOpsList.textContent = '暂无操作记录';
          return;
        }
        ops.forEach((item) => {
          const row = document.createElement('div');
          row.className = 'op-item';
          row.textContent = `${item.op || ''} · ${item.detail || ''}`;
          editOpsList.appendChild(row);
        });
      };

      const switchTab = (tabId) => {
        stepButtons.forEach((btn) => {
          btn.classList.toggle('active', btn.dataset.tab === tabId);
        });
        Object.entries(tabPanels).forEach(([id, panel]) => {
          if (panel) panel.classList.toggle('active', id === tabId);
        });
      };

      stepButtons.forEach((btn) => {
        btn.onclick = () => switchTab(btn.dataset.tab);
      });
      if (goRequirementBtn) {
        goRequirementBtn.onclick = () => switchTab('requirementTab');
      }
      if (librarySearchEl) {
        librarySearchEl.oninput = () => renderLibrary();
      }
      if (librarySortEl) {
        librarySortEl.onchange = () => renderLibrary();
      }
      layoutModeInnerRadios.forEach((radio) => {
        radio.onchange = () => {
          layoutModeInner = radio.value;
          const isTemplate = layoutModeInner === 'template';
          if (smartBlock) smartBlock.style.display = isTemplate ? 'none' : 'block';
          if (templateBlock) templateBlock.style.display = isTemplate ? 'block' : 'none';
          if (isTemplate && templateSelect) renderTemplatePreview(templateSelect.value || 'two-col');
          updateLayoutHint();
        };
      });
      if (templateSelect) {
        templateSelect.onchange = () => renderTemplatePreview(templateSelect.value || 'two-col');
      }
      if (openExperimentBtn && experimentModal) {
        openExperimentBtn.onclick = () => {
          experimentModal.classList.add('active');
        };
      }
      if (closeExperimentBtn && experimentModal) {
        closeExperimentBtn.onclick = () => experimentModal.classList.remove('active');
      }
      if (experimentModal) {
        const backdrop = experimentModal.querySelector('.modal-backdrop');
        if (backdrop) {
          backdrop.onclick = () => experimentModal.classList.remove('active');
        }
      }

      if (editProviderEl && providerEl) {
        editProviderEl.value = providerEl.value;
      }

      const renderLibraryDetail = (item) => {
        if (!libraryDetailEl) return;
        libraryDetailEl.innerHTML = '';
        if (!item) {
          const empty = document.createElement('div');
          empty.className = 'empty';
          empty.textContent = '在左侧选择组件以查看详情';
          libraryDetailEl.appendChild(empty);
          return;
        }

        const header = document.createElement('div');
        header.className = 'row';
        header.style.alignItems = 'center';
        const nameInput = document.createElement('input');
        nameInput.className = 'meta-input';
        nameInput.value = item.name || '';
        nameInput.placeholder = '组件名称';
        nameInput.onchange = () => updateComponentMeta(item.id, { name: nameInput.value });

        const headerActions = document.createElement('div');
        headerActions.className = 'row';
        headerActions.style.justifyContent = 'flex-end';
        headerActions.style.flex = '0 0 auto';
        const slotBtn = document.createElement('button');
        slotBtn.textContent = '配置插槽';
        slotBtn.onclick = () =>
          parent.postMessage({ pluginMessage: { type: 'request-slots', id: item.id } }, '*');
        const removeBtn = document.createElement('button');
        removeBtn.textContent = '移除';
        removeBtn.onclick = () =>
          parent.postMessage({ pluginMessage: { type: 'remove-component', id: item.id } }, '*');
        headerActions.appendChild(slotBtn);
        headerActions.appendChild(removeBtn);
        header.appendChild(nameInput);
        header.appendChild(headerActions);
        libraryDetailEl.appendChild(header);

        const meta = document.createElement('div');
        meta.className = 'lib-meta';
        meta.textContent = `${Math.round(item.width)}x${Math.round(item.height)}${
          item.primaryColor ? ` | 主色:${item.primaryColor}` : ''
        }${item.sampleText ? ` | 文案:${item.sampleText}` : ''}`;
        libraryDetailEl.appendChild(meta);

        const badgeRow = document.createElement('div');
        badgeRow.className = 'chip-row';
        badgeRow.appendChild(createBadge('信息', item.infoCategory || '未设定'));
        badgeRow.appendChild(createBadge('占用', item.visualFootprint || ''));
        badgeRow.appendChild(createBadge('密度', item.infoDensityProfile || ''));
        badgeRow.appendChild(createBadge('布局', item.layoutRole || ''));
        libraryDetailEl.appendChild(badgeRow);

        const metaGrid = document.createElement('div');
        metaGrid.className = 'meta-grid';
        const desc = document.createElement('textarea');
        desc.placeholder = '描述';
        desc.value = item.description || '';
        desc.onchange = () => updateComponentMeta(item.id, { description: desc.value });
        const tags = document.createElement('input');
        tags.className = 'tag-input';
        tags.placeholder = '标签，逗号分隔';
        tags.value = (item.tags || []).join(', ');
        tags.onchange = () => {
          const values = tags.value
            .split(',')
            .map((v) => v.trim())
            .filter(Boolean);
          updateComponentMeta(item.id, { tags: values });
        };
        metaGrid.appendChild(desc);
        metaGrid.appendChild(tags);
        libraryDetailEl.appendChild(metaGrid);

        const dataTypeLabel = document.createElement('div');
        dataTypeLabel.className = 'summary';
        dataTypeLabel.textContent = '支持的数据类型';
        const chipRow = document.createElement('div');
        chipRow.className = 'chip-row';
        DATA_TYPES.forEach((dt) => {
          const chip = document.createElement('div');
          chip.className = 'chip';
          chip.textContent = dt;
          const selected = item.supportedDataTypes?.includes(dt);
          if (selected) chip.classList.add('selected');
          chip.onclick = () => {
            const next = new Set(item.supportedDataTypes || []);
            if (next.has(dt)) next.delete(dt);
            else next.add(dt);
            updateComponentMeta(item.id, { supportedDataTypes: Array.from(next) });
          };
          chipRow.appendChild(chip);
        });
        libraryDetailEl.appendChild(dataTypeLabel);
        libraryDetailEl.appendChild(chipRow);

        const detailGrid = document.createElement('div');
        detailGrid.className = 'detail-grid';
        const viewportValue = Array.isArray(item.recommendedViewportZone)
          ? item.recommendedViewportZone[0]
          : item.recommendedViewportZone;
        const buildSelectField = (label, options, value, handler) => {
          const wrap = document.createElement('div');
          const lbl = document.createElement('div');
          lbl.className = 'detail-label';
          lbl.textContent = label;
          const select = document.createElement('select');
          const empty = document.createElement('option');
          empty.value = '';
          empty.textContent = '未设置';
          select.appendChild(empty);
          options.forEach((opt) => {
            const o = document.createElement('option');
            o.value = opt;
            o.textContent = opt;
            select.appendChild(o);
          });
          select.value = value || '';
          select.onchange = () => handler(select.value || null);
          wrap.appendChild(lbl);
          wrap.appendChild(select);
          return wrap;
        };
        detailGrid.appendChild(
          buildSelectField('信息类别', INFO_CATEGORIES, item.infoCategory, (val) =>
            updateComponentMeta(item.id, { infoCategory: val })
          )
        );
        detailGrid.appendChild(
          buildSelectField('优先级适配', PRIORITY_AFFINITIES, item.priorityAffinity, (val) =>
            updateComponentMeta(item.id, { priorityAffinity: val })
          )
        );
        detailGrid.appendChild(
          buildSelectField('视觉占用', VISUAL_FOOTPRINTS, item.visualFootprint, (val) =>
            updateComponentMeta(item.id, { visualFootprint: val })
          )
        );
        detailGrid.appendChild(
          buildSelectField('信息密度', DENSITY_PROFILES, item.infoDensityProfile, (val) =>
            updateComponentMeta(item.id, { infoDensityProfile: val })
          )
        );
        detailGrid.appendChild(
          buildSelectField('动态行为', DYNAMIC_BEHAVIORS, item.dynamicBehavior, (val) =>
            updateComponentMeta(item.id, { dynamicBehavior: val })
          )
        );
        detailGrid.appendChild(
          buildSelectField('关键性支持', CRITICALITY_OPTIONS, item.criticalitySupport, (val) =>
            updateComponentMeta(item.id, { criticalitySupport: val })
          )
        );
        detailGrid.appendChild(
          buildSelectField('布局角色', LAYOUT_ROLES, item.layoutRole, (val) =>
            updateComponentMeta(item.id, { layoutRole: val })
          )
        );
        detailGrid.appendChild(
          buildSelectField('推荐视域', VIEWPORT_ZONES, viewportValue, (val) =>
            updateComponentMeta(item.id, { recommendedViewportZone: val })
          )
        );
        const maxWrap = document.createElement('div');
        const maxLabel = document.createElement('div');
        maxLabel.className = 'detail-label';
        maxLabel.textContent = '单页推荐最大实例数';
        const maxInput = document.createElement('input');
        maxInput.type = 'number';
        maxInput.min = '0';
        maxInput.placeholder = '可选';
        maxInput.value =
          typeof item.recommendedMaxInstancesPerPage === 'number'
            ? String(item.recommendedMaxInstancesPerPage)
            : '';
        maxInput.onchange = () => {
          const val = parseInt(maxInput.value, 10);
          updateComponentMeta(item.id, {
            recommendedMaxInstancesPerPage: Number.isFinite(val) ? val : null
          });
        };
        maxWrap.appendChild(maxLabel);
        maxWrap.appendChild(maxInput);
        detailGrid.appendChild(maxWrap);
        libraryDetailEl.appendChild(detailGrid);

        const stageLabel = document.createElement('div');
        stageLabel.className = 'detail-label';
        stageLabel.textContent = '任务阶段适配';
        const stageChips = document.createElement('div');
        stageChips.className = 'chip-row';
        TASK_STAGES.forEach((stage) => {
          const chip = document.createElement('div');
          chip.className = 'chip';
          chip.textContent = stage;
          const selected = (item.taskStageAffinity || []).includes(stage);
          if (selected) chip.classList.add('selected');
          chip.onclick = () => {
            const next = new Set(item.taskStageAffinity || []);
            if (next.has(stage)) next.delete(stage);
            else next.add(stage);
            updateComponentMeta(item.id, { taskStageAffinity: Array.from(next) });
          };
          stageChips.appendChild(chip);
        });
        libraryDetailEl.appendChild(stageLabel);
        libraryDetailEl.appendChild(stageChips);

        const interactionWrap = document.createElement('div');
        const interactionLabel = document.createElement('div');
        interactionLabel.className = 'detail-label';
        interactionLabel.textContent = '交互支持特征';
        const interactionInput = document.createElement('input');
        interactionInput.className = 'meta-input';
        interactionInput.placeholder = '逗号分隔，如 hover, drilldown';
        interactionInput.value = (item.interactionSupport || []).join(', ');
        interactionInput.onchange = () => {
          updateComponentMeta(item.id, {
            interactionSupport: parseListInput(interactionInput.value)
          });
        };
        interactionWrap.appendChild(interactionLabel);
        interactionWrap.appendChild(interactionInput);
        libraryDetailEl.appendChild(interactionWrap);

        const stats = item.layerStats || {};
        const statsLabel = document.createElement('div');
        statsLabel.className = 'detail-label';
        statsLabel.textContent = '图层结构统计';
        const statsBox = document.createElement('div');
        statsBox.className = 'readonly-box';
        statsBox.textContent = `文本:${stats.textNodeCount ?? 0} | 形状:${stats.shapeNodeCount ?? 0} | 深度:${stats.groupDepth ?? 1} | AutoLayout:${stats.autoLayoutEnabled ? '是' : '否'} | 字号:${stats.dominantFontSize || '-'} | 色数:${stats.colorChannelCount ?? 0}`;
        libraryDetailEl.appendChild(statsLabel);
        libraryDetailEl.appendChild(statsBox);

        const note = document.createElement('textarea');
        note.className = 'lib-note';
        note.rows = 2;
        note.placeholder = '备注 / 用途说明';
        note.value = item.note || '';
        note.onchange = () => {
          parent.postMessage(
            { pluginMessage: { type: 'update-note', id: item.id, note: note.value } },
            '*'
          );
        };
        libraryDetailEl.appendChild(note);

        const slotAnchor = document.createElement('div');
        slotAnchor.id = 'slotPanelHost';
        libraryDetailEl.appendChild(slotAnchor);
      };

      const renderLibrary = () => {
        libraryListEl.innerHTML = '';
        if (!library.length) {
          libraryListEl.textContent = '暂无组件，选中 Section 后点击“导入”';
          useLibraryEl.checked = false;
          useLibraryEl.disabled = true;
          renderLibraryDetail(null);
          return;
        }
        useLibraryEl.disabled = false;
        if (useLibraryEl.dataset.userToggled !== 'true') {
          useLibraryEl.checked = true;
        }
        const keyword = (librarySearchEl?.value || '').trim().toLowerCase();
        const sortBy = librarySortEl?.value || 'updated';
        const filtered = library
          .filter((item) => {
            if (!keyword) return true;
            const text = `${item.name || ''} ${(item.tags || []).join(' ')}`.toLowerCase();
            return text.includes(keyword);
          })
          .sort((a, b) => {
            if (sortBy === 'name') return (a.name || '').localeCompare(b.name || '');
            if (sortBy === 'size') return (b.width * b.height || 0) - (a.width * a.height || 0);
            return (b.lastUpdated || 0) - (a.lastUpdated || 0);
          });
        if (!filtered.length) {
          libraryListEl.textContent = '未找到匹配组件';
          renderLibraryDetail(null);
          return;
        }
        if (!selectedComponentId || !filtered.find((it) => it.id === selectedComponentId)) {
          selectedComponentId = filtered[0].id;
        }

        filtered.forEach((item) => {
          const tile = document.createElement('div');
          tile.className = 'lib-tile';
          if (item.id === selectedComponentId) tile.classList.add('active');
          const titleRow = document.createElement('div');
          titleRow.className = 'title-row';
          const name = document.createElement('div');
          name.textContent = item.name || '未命名';
          const metaRight = document.createElement('div');
          metaRight.className = 'summary';
          metaRight.textContent = item.primaryColor ? item.primaryColor : '';
          titleRow.appendChild(name);
          titleRow.appendChild(metaRight);
          const metaRow = document.createElement('div');
          metaRow.className = 'meta-row';
          metaRow.textContent = `${Math.round(item.width)}x${Math.round(item.height)} · ${
            item.infoCategory || '未设定'
          } · ${item.infoDensityProfile || '密度?'} · 更新时间 ${item.lastUpdated ? new Date(item.lastUpdated).toLocaleDateString() : '--'}`;
          tile.appendChild(titleRow);
          tile.appendChild(metaRow);
          tile.onclick = () => {
            selectedComponentId = item.id;
            renderLibrary();
          };
          libraryListEl.appendChild(tile);
        });
        const activeItem = library.find((it) => it.id === selectedComponentId) || null;
        renderLibraryDetail(activeItem);
      };

      runButton.onclick = () => {
        const prompt = promptEl.value;
        const provider = providerEl.value;
        const useLibrary = useLibraryEl.checked;

        setLoading(true);

        parent.postMessage(
          {
            pluginMessage: {
              type: 'generate-design',
              prompt,
              apiKey: '', // API Key 交由后端管理
              provider,
              useLibrary
            }
          },
          '*'
        );
      };

      importBtn.onclick = () => {
        parent.postMessage({ pluginMessage: { type: 'import-section' } }, '*');
      };

      exportBtn.onclick = () => {
        parent.postMessage({ pluginMessage: { type: 'export-library' } }, '*');
      };

      enrichBtn.onclick = () => {
        statusEl.textContent = '向 AI 请求元数据推荐…';
        parent.postMessage({ pluginMessage: { type: 'enrich-library' } }, '*');
      };

      if (pickBackgroundBtn) {
        pickBackgroundBtn.onclick = () => {
          parent.postMessage({ pluginMessage: { type: 'set-background-from-selection' } }, '*');
        };
      }

      if (generatePlanBtn) {
        generatePlanBtn.onclick = () => {
          if (layoutModeInner !== 'smart') {
            layoutPlanStatusEl.textContent = '当前为基础模板，请切换到智能布局模式';
            return;
          }
          if (!selectedBindingPageId) {
            layoutPlanStatusEl.textContent = '请先选择页面';
            return;
          }
          layoutPlanStatusEl.textContent = '生成布局方案中…';
          parent.postMessage(
            {
              pluginMessage: {
                type: 'generate-layout-plan',
                pageId: selectedBindingPageId,
                screenType: screenTypeEl.value,
                backgroundNodeId
              }
            },
            '*'
          );
        };
      }


      if (applyPlanBtn) {
        applyPlanBtn.onclick = () => {
          if (layoutModeInner !== 'smart') {
            layoutPlanStatusEl.textContent = '当前为基础模板，请切换到智能布局模式';
            return;
          }
          if (!layoutPlan) {
            layoutPlanStatusEl.textContent = '请先生成布局方案';
            return;
          }
          layoutPlanStatusEl.textContent = '正在生成到画布…';
          parent.postMessage({ pluginMessage: { type: 'apply-layout-plan' } }, '*');
        };
      }

      parseDocBtn.onclick = () => {
        const docText = docTextEl.value;
        parent.postMessage({ pluginMessage: { type: 'parse-doc', docText } }, '*');
      };

      if (loadExperimentBtn) {
        loadExperimentBtn.onclick = () => {
          if (!selectedExperimentId || experimentLoading) return;
          setExperimentLoading(true);
          if (experimentStatusEl) experimentStatusEl.textContent = '加载中…';
          parent.postMessage(
            { pluginMessage: { type: 'load-experiment', experimentId: selectedExperimentId } },
            '*'
          );
        };
      }

      saveReqBtn.onclick = () => {
        if (!requirement) return;
        parent.postMessage({ pluginMessage: { type: 'update-requirement', data: requirement } }, '*');
        statusEl.textContent = '已保存解析结果';
        statusEl.dataset.state = 'success';
      };
      if (saveReqBindingBtn) {
        saveReqBindingBtn.onclick = () => {
          if (!requirement) return;
          parent.postMessage({ pluginMessage: { type: 'update-requirement', data: requirement } }, '*');
          statusEl.textContent = '已保存绑定';
          statusEl.dataset.state = 'success';
        };
      }

      recommendBtn.onclick = () => {
        if (!selectedBindingPageId) {
          statusEl.textContent = '请先选择页面';
          statusEl.dataset.state = 'error';
          return;
        }
        statusEl.textContent = '向 AI 请求组件推荐…';
        parent.postMessage({ pluginMessage: { type: 'recommend-bindings', pageId: selectedBindingPageId } }, '*');
      };

      generatePagesBtn.onclick = () => {
        if (!selectedPageIds.size) {
          statusEl.textContent = '请选择至少一个页面';
          statusEl.dataset.state = 'error';
          return;
        }
        const pageIds = Array.from(selectedPageIds);
        const template = templateSelect.value || 'two-col';
        parent.postMessage({
          pluginMessage: { type: 'generate-pages', pageIds, template, useLibrary: true }
        }, '*');
        statusEl.textContent = `生成 ${pageIds.length} 个页面中…`;
        statusEl.dataset.state = 'loading';
      };

      applyEditBtn.onclick = () => {
        const prompt = (editPromptEl.value || '').trim();
        if (!prompt) {
          editStatusEl.textContent = '请输入编辑指令';
          editStatusEl.dataset.state = 'error';
          return;
        }
        parent.postMessage(
          {
            pluginMessage: {
              type: 'edit-page',
              prompt,
              provider: editProviderEl.value,
              apiKey: (editApiKeyEl.value || '').trim()
            }
          },
          '*'
        );
        setEditLoading(true);
      };

      undoEditBtn.onclick = () => {
        parent.postMessage({ pluginMessage: { type: 'undo-edit' } }, '*');
      };

      useLibraryEl.onchange = () => {
        useLibraryEl.dataset.userToggled = 'true';
      };

      const updateRequirementSummary = (keepSelection = true) => {
        if (!requirement) {
          if (reqStatsEl) reqStatsEl.textContent = '';
          return;
        }
        const { phases = [], roles = [], conditions = [], infoItems = [], pages = [] } = requirement;
        if (reqStatsEl) {
          reqStatsEl.textContent = `阶段 ${phases.length} · 角色 ${roles.length} · 条件 ${conditions.length} · 信息项 ${infoItems.length} · 页面 ${pages.length}`;
        }
        renderMetaLists();
        renderPageListSingle(keepSelection);
        renderPageListBinding(keepSelection);
      };

      const renderMetaLists = () => {
        const renderList = (el, items) => {
          if (!el) return;
          el.innerHTML = '';
          if (!items?.length) {
            el.textContent = '暂无';
            return;
          }
          items.forEach((item) => {
            const row = document.createElement('div');
            row.className = 'req-item';
            row.innerHTML = `<div>${item.name || item.id}</div>`;
            el.appendChild(row);
          });
        };
        renderList(phaseListEl, requirement?.phases || []);
        renderList(roleListEl, requirement?.roles || []);
        renderList(conditionListEl, requirement?.conditions || []);
        renderList(infoItemListEl, requirement?.infoItems || []);
      };

      const renderPageListSingle = (keepSelection = true) => {
        if (!pageListSingleEl) return;
        pageListSingleEl.innerHTML = '';
        if (!requirement?.pages?.length) {
          pageListSingleEl.textContent = '暂无解析结果';
          if (pageInfoSingleEl) pageInfoSingleEl.innerHTML = '';
          selectedPageIdSingle = null;
          return;
        }
        const prevSelected = keepSelection ? selectedPageIdSingle : null;
        requirement.pages.forEach((page) => {
          const row = document.createElement('div');
          row.className = 'req-item';
          if (selectedPageIdSingle === page.id) row.classList.add('active');
          const phase = requirement.phases?.find((p) => p.id === page.phaseId);
          const role = requirement.roles?.find((r) => r.id === page.roleId);
          const cond = requirement.conditions?.find((c) => c.id === page.conditionId);
          row.innerHTML = `
            <div>${page.name || '未命名页面'}</div>
            <div class="summary">
              <span class="pill">${phase?.name || 'Phase'}</span>
              <span class="pill">${role?.name || 'Role'}</span>
              <span class="pill">${cond?.name || 'Condition'}</span>
            </div>
          `;
          row.onclick = () => {
            selectedPageIdSingle = page.id;
            renderPageListSingle();
            renderPageInfoSingle(page);
          };
          pageListSingleEl.appendChild(row);
        });
        if (!selectedPageIdSingle && requirement.pages.length) {
          selectedPageIdSingle = requirement.pages[0].id;
        }
        if (selectedPageIdSingle) {
          const current =
            requirement.pages.find((p) => p.id === selectedPageIdSingle) || requirement.pages[0];
          selectedPageIdSingle = current?.id || null;
          if (selectedPageIdSingle) renderPageInfoSingle(current);
        }
      };

      const renderPageInfoSingle = (page) => {
        if (!pageInfoSingleEl) return;
        pageInfoSingleEl.innerHTML = '';
        if (!page?.infoPriorities?.length) {
          pageInfoSingleEl.textContent = '无信息项';
          return;
        }
        const rows = page.infoPriorities
          .slice()
          .sort((a, b) => a.priority - b.priority)
          .map((item) => {
            const info = requirement.infoItems?.find((x) => x.id === item.infoItemId);
            const row = document.createElement('div');
            row.className = 'priority-row';
            const tier = getTier(item);
            const tierSelect = document.createElement('select');
            ['high', 'medium', 'low'].forEach((t) => {
              const opt = document.createElement('option');
              opt.value = t;
              opt.textContent = t;
              tierSelect.appendChild(opt);
            });
            tierSelect.value = tier;
            tierSelect.onchange = () => {
              const nextTier = tierSelect.value;
              if (!canAssignTier(page, item, nextTier)) {
                statusEl.textContent = '高优先级 ≤1，中优先级 ≤4，请调整';
                statusEl.dataset.state = 'error';
                tierSelect.value = tier;
                return;
              }
              setTier(item, nextTier);
              renderPageInfoSingle(page);
              statusEl.textContent = '';
            };
            const nameInput = document.createElement('input');
            nameInput.className = 'small-input';
            nameInput.value = info?.name || item.infoItemId;
            nameInput.onchange = () => {
              if (info) info.name = nameInput.value;
            };
            const noteInput = document.createElement('input');
            noteInput.className = 'small-input';
            noteInput.placeholder = '备注';
            noteInput.value = item.note || '';
            noteInput.onchange = () => {
              item.note = noteInput.value;
            };
            row.appendChild(tierSelect);
            row.appendChild(nameInput);
            row.appendChild(noteInput);
            return row;
          });
        rows.forEach((r) => pageInfoSingleEl.appendChild(r));
      };

      const renderPageListBinding = (keepSelection = true) => {
        if (!pageListBindingEl) return;
        pageListBindingEl.innerHTML = '';
        if (!requirement?.pages?.length) {
          pageListBindingEl.textContent = '暂无解析结果';
          if (pageInfoBindingEl) pageInfoBindingEl.innerHTML = '';
          selectedBindingPageId = null;
          return;
        }
        requirement.pages.forEach((page) => {
          const row = document.createElement('div');
          row.className = 'req-item';
          if (selectedPageIds.has(page.id)) row.classList.add('active');
          const phase = requirement.phases?.find((p) => p.id === page.phaseId);
          const role = requirement.roles?.find((r) => r.id === page.roleId);
          const cond = requirement.conditions?.find((c) => c.id === page.conditionId);
          row.innerHTML = `
            <div>${page.name || '未命名页面'}</div>
            <div class="summary">
              <span class="pill">${phase?.name || 'Phase'}</span>
              <span class="pill">${role?.name || 'Role'}</span>
              <span class="pill">${cond?.name || 'Condition'}</span>
            </div>
          `;
          row.onclick = () => {
            if (selectedPageIds.has(page.id)) {
              selectedPageIds.delete(page.id);
            } else {
              selectedPageIds.add(page.id);
            }
            selectedBindingPageId = page.id;
            renderPageListBinding();
            renderPageInfoBinding(page);
            updateLayoutHint();
          };
          pageListBindingEl.appendChild(row);
        });
        if (!selectedPageIds.size && requirement.pages.length) {
          selectedPageIds.add(requirement.pages[0].id);
        }
        if (!selectedBindingPageId && selectedPageIds.size) {
          selectedBindingPageId = Array.from(selectedPageIds)[0];
        }
        if (selectedBindingPageId) {
          const current =
            requirement.pages.find((p) => p.id === selectedBindingPageId) ||
            requirement.pages[0];
          selectedBindingPageId = current?.id || null;
          if (selectedBindingPageId) renderPageInfoBinding(current);
        }
        updateLayoutHint();
      };

      const renderPageInfoBinding = (page) => {
        if (!pageInfoBindingEl) return;
        pageInfoBindingEl.innerHTML = '';
        if (!page?.infoPriorities?.length) {
          pageInfoBindingEl.textContent = '无信息项';
          return;
        }
        const rows = page.infoPriorities
          .slice()
          .sort((a, b) => a.priority - b.priority)
          .map((item) => {
            const info = requirement.infoItems?.find((x) => x.id === item.infoItemId);
            const row = document.createElement('div');
            row.className = 'priority-row';
            const tier = getTier(item);
            const tierBadge = document.createElement('span');
            tierBadge.className = 'pill';
            tierBadge.textContent = tier === 'high' ? '高' : tier === 'medium' ? '中' : '低';
            const nameLabel = document.createElement('div');
            nameLabel.className = 'small-input';
            nameLabel.style.border = 'none';
            nameLabel.style.background = 'transparent';
            nameLabel.style.padding = '0';
            nameLabel.textContent = info?.name || item.infoItemId;
            const noteLabel = document.createElement('div');
            noteLabel.className = 'small-input';
            noteLabel.style.border = 'none';
            noteLabel.style.background = 'transparent';
            noteLabel.style.padding = '0';
            noteLabel.style.color = '#9ca3af';
            noteLabel.textContent = item.note || '';

            const bindingSelect = document.createElement('select');
            const noneOpt = document.createElement('option');
            noneOpt.value = '';
            noneOpt.textContent = '未绑定组件';
            bindingSelect.appendChild(noneOpt);
            library.forEach((comp) => {
              const opt = document.createElement('option');
              opt.value = comp.id;
              opt.textContent = comp.name;
              bindingSelect.appendChild(opt);
            });
            const currentBinding = (page.preferredBindings || []).find(
              (b) => b.infoItemId === item.infoItemId
            );
            bindingSelect.value = currentBinding?.componentId || '';
            bindingSelect.onchange = () => {
              setBinding(page, item.infoItemId, bindingSelect.value);
              updateLayoutHint();
            };

            row.appendChild(tierBadge);
            row.appendChild(nameLabel);
            row.appendChild(noteLabel);
            row.appendChild(bindingSelect);
            return row;
          });
        rows.forEach((r) => pageInfoBindingEl.appendChild(r));
      };

      copyExportBtn.onclick = () => {
        if (!exportText.value) return;
        exportText.select();
        document.execCommand('copy');
        statusEl.textContent = '已复制到剪贴板';
        statusEl.dataset.state = 'success';
      };

      const getTier = (item) => {
        if (item.tier) return item.tier;
        if (item.priority <= 1) return 'high';
        if (item.priority <= 5) return 'medium';
        return 'low';
      };

      const setTier = (item, tier) => {
        item.tier = tier;
        if (tier === 'high') item.priority = 1;
        else if (tier === 'medium') item.priority = 5;
        else item.priority = 9;
      };

      const setBinding = (page, infoItemId, componentId) => {
        const bindings = page.preferredBindings || [];
        const found = bindings.find((b) => b.infoItemId === infoItemId);
        if (found) {
          found.componentId = componentId || undefined;
        } else {
          bindings.push({ infoItemId, componentId: componentId || undefined });
        }
        page.preferredBindings = bindings;
        updateLayoutHint();
      };

      const canAssignTier = (page, currentItem, nextTier) => {
        const counts = { high: 0, medium: 0, low: 0 };
        page.infoPriorities.forEach((it) => {
          const t = it === currentItem ? nextTier : getTier(it);
          counts[t] += 1;
        });
        if (counts.high > 1) return false;
        if (counts.medium > 4) return false;
        return true;
      };

      const updateLayoutHint = () => {
        if (!layoutHintEl) return;
        const selectedCount = selectedPageIds.size;
        const bindingCount = requirement?.pages
          ? requirement.pages.reduce((acc, p) => {
              const num = (p.preferredBindings || []).filter((b) => b.componentId).length;
              return acc + num;
            }, 0)
          : 0;
        layoutHintEl.textContent = `已选页面 ${selectedCount} 个 · 已绑定 ${bindingCount} 条`;
        const isSmart = layoutModeInner === 'smart';
        if (generatePlanBtn) generatePlanBtn.disabled = !isSmart || selectedCount === 0;
        if (applyPlanBtn) applyPlanBtn.disabled = !isSmart || selectedCount === 0 || !lastLayoutPlan;
        if (generatePagesBtn) generatePagesBtn.disabled = selectedCount === 0;
      };

      const renderTemplatePreview = (tpl) => {
        if (!templatePreviewEl) return;
        templatePreviewEl.innerHTML = '';
        const presets = {
          'two-col': [
            { x: 5, y: 5, w: 44, h: 90 },
            { x: 51, y: 5, w: 44, h: 90 }
          ],
          'three-col': [
            { x: 3, y: 5, w: 30, h: 90 },
            { x: 35, y: 5, w: 30, h: 90 },
            { x: 67, y: 5, w: 30, h: 90 }
          ],
          'main-side': [
            { x: 3, y: 5, w: 62, h: 90 },
            { x: 68, y: 5, w: 29, h: 90 }
          ],
          dashboard: [
            { x: 3, y: 5, w: 62, h: 50 },
            { x: 68, y: 5, w: 29, h: 50 },
            { x: 3, y: 60, w: 30, h: 35 },
            { x: 35, y: 60, w: 62, h: 35 }
          ]
        };
        const cells = presets[tpl] || presets['two-col'];
        cells.forEach((c) => {
          const div = document.createElement('div');
          div.className = 'tp-row';
          div.style.left = `${c.x}%`;
          div.style.top = `${c.y}%`;
          div.style.width = `${c.w}%`;
          div.style.height = `${c.h}%`;
          templatePreviewEl.appendChild(div);
        });
      };

      // Request library & requirement on load
      parent.postMessage({ pluginMessage: { type: 'request-library' } }, '*');
      parent.postMessage({ pluginMessage: { type: 'request-requirement' } }, '*');
      renderEditOps([], '');
      renderExperiments();
      renderLayoutPreview(null);
      updateLayoutHint();
      if (templateSelect) renderTemplatePreview(templateSelect.value || 'two-col');

      window.onmessage = (event) => {
        const msg = event.data.pluginMessage;
        if (!msg) return;

        if (msg.type === 'experiments-list') {
          experiments = Array.isArray(msg.items) ? msg.items : [];
          const prevSelected = selectedExperimentId;
          selectedExperimentId =
            experiments.find((e) => e.id === prevSelected)?.id ||
            (experiments[0] ? experiments[0].id : null);
          if (experimentStatusEl) {
            if (msg.error) {
              experimentStatusEl.textContent = `加载失败：${msg.error}`;
            } else if (experiments.length) {
              experimentStatusEl.textContent = `已同步 ${experiments.length} 个场景`;
            } else {
              experimentStatusEl.textContent = '当前无可用实验场景';
            }
          }
          setExperimentLoading(false);
          renderExperiments();
          return;
        }

        if (msg.type === 'experiment-loaded') {
          loadedExperimentName = msg.name || msg.id;
          setExperimentLoading(false);
          if (experimentStatusEl) {
            experimentStatusEl.textContent = `已加载场景：${loadedExperimentName}`;
          }
          return;
        }

        if (msg.type === 'load-experiment-error') {
          setExperimentLoading(false);
          if (experimentStatusEl) {
            experimentStatusEl.textContent = `加载失败：${msg.message || '请稍后重试'}`;
          }
          return;
        }

        if (msg.type === 'layout-plan') {
          layoutPlan = msg.plan || null;
          layoutPlanStatusEl.textContent = '已生成布局方案';
          renderLayoutPreview(layoutPlan);
          if (applyPlanBtn) applyPlanBtn.disabled = false;
          return;
        }

        if (msg.type === 'layout-plan-error') {
          layoutPlanStatusEl.textContent = `布局方案失败：${msg.message || ''}`;
          if (applyPlanBtn) applyPlanBtn.disabled = true;
          return;
        }

        if (msg.type === 'layout-plan-applied') {
          layoutPlanStatusEl.textContent = '已生成到画布';
          return;
        }

        if (msg.type === 'background-selected') {
          backgroundNodeId = msg.nodeId;
          backgroundPreviewEl.textContent = `已选：${msg.name || msg.nodeId}`;
          return;
        }

        if (msg.type === 'background-select-error') {
          backgroundPreviewEl.textContent = msg.message || '无法选中背景节点';
          return;
        }

        if (msg.type === 'library') {
          library = msg.items || [];
          renderLibrary();
          return;
        }

        if (msg.type === 'slots') {
          slotState = {
            componentId: msg.componentId,
            candidates: msg.candidates || [],
            slots: msg.slots || []
          };
          renderSlots();
          return;
        }

        if (msg.type === 'library-export') {
          const json = JSON.stringify(msg.data, null, 2);
          exportText.value = json;
          exportWrap.style.display = 'block';
          try {
            if (navigator.clipboard) {
              navigator.clipboard.writeText(json).catch(() => {});
            }
          } catch (_error) {
            // ignore clipboard errors
          }
          statusEl.textContent = '已导出组件库 JSON，下方可复制';
          statusEl.dataset.state = 'success';
          return;
        }

        if (msg.type === 'library-enriched') {
          statusEl.textContent = `已应用 ${msg.applied || 0} 个组件的推荐`;
          statusEl.dataset.state = 'success';
          return;
        }

        if (msg.type === 'requirement') {
          requirement = msg.data;
          updateRequirementSummary(true);
          return;
        }

        if (msg.type === 'edit-ops') {
          renderEditOps(msg.operations || [], msg.summary || '');
          return;
        }

        if (msg.type === 'edit-status') {
          if (msg.state === 'loading') {
            setEditLoading(true);
            editStatusEl.textContent = msg.message || '正在编辑…';
            editStatusEl.dataset.state = 'loading';
          } else {
            setEditLoading(false);
          }

          if (msg.state === 'error') {
            editStatusEl.dataset.state = 'error';
            editStatusEl.textContent = `错误：${msg.message || '编辑失败'}`;
          } else if (msg.state === 'success') {
            editStatusEl.dataset.state = 'success';
            editStatusEl.textContent = msg.message || '编辑完成';
            setTimeout(() => {
              if (editStatusEl.dataset.state === 'success') {
                editStatusEl.textContent = '';
                editStatusEl.dataset.state = '';
              }
            }, 1500);
          } else if (
            msg.state === 'idle' &&
            editStatusEl.dataset.state !== 'error' &&
            editStatusEl.dataset.state !== 'success'
          ) {
            editStatusEl.dataset.state = '';
            editStatusEl.textContent = '';
          }
          return;
        }

        if (msg.type === 'status') {
          if (msg.state === 'loading') {
            setLoading(true);
          } else {
            setLoading(false);
          }

          if (msg.state === 'error') {
            statusEl.dataset.state = 'error';
            statusEl.textContent = `错误：${msg.message || '生成失败'}`;
          } else if (msg.state === 'success') {
            statusEl.dataset.state = 'success';
            statusEl.textContent = '生成完成';
            setTimeout(() => {
              if (statusEl.dataset.state === 'success') {
                statusEl.textContent = '';
                statusEl.dataset.state = '';
              }
            }, 1500);
          } else if (msg.state === 'idle' && statusEl.dataset.state !== 'error') {
            statusEl.dataset.state = '';
            statusEl.textContent = '';
          }
        }
      };

      const renderSlots = () => {
        const panelId = 'slotPanel';
        let panel = document.getElementById(panelId);
        if (!slotState) {
          if (panel) panel.remove();
          return;
        }
        const host = document.getElementById('slotPanelHost') || libraryDetailEl || libraryListEl?.parentNode;
        if (!panel) {
          panel = document.createElement('div');
          panel.id = panelId;
          panel.className = 'slot-panel';
          host?.appendChild(panel);
        } else if (host && panel.parentNode !== host) {
          host.appendChild(panel);
        }
        panel.innerHTML = '';

        const header = document.createElement('div');
        header.className = 'slot-header';
        const comp = library.find((c) => c.id === slotState.componentId);
        header.textContent = `插槽配置：${comp?.name || slotState.componentId}`;
        panel.appendChild(header);

        const summary = document.createElement('div');
        summary.className = 'slot-summary';
        const configuredCount = slotState.slots?.length || 0;
        summary.innerHTML = `<span class="badge accent">已配置 ${configuredCount}</span><span class="badge">候选 ${slotState.candidates.length}</span>`;
        panel.appendChild(summary);

        const hint = document.createElement('div');
        hint.className = 'slot-hint';
        hint.innerHTML = '请选择 slot 类型和数据类型，常用搭配：label + text / numericValue + unit / state / alert / listItem。';
        panel.appendChild(hint);

        const filterInput = document.createElement('input');
        filterInput.className = 'slot-filter';
        filterInput.placeholder = '筛选节点名称或文案（回车应用）';
        filterInput.value = slotFilter;
        filterInput.onchange = () => {
          slotFilter = filterInput.value.trim().toLowerCase();
          renderSlots();
        };
        panel.appendChild(filterInput);

        const grid = document.createElement('div');
        grid.className = 'slot-grid';

        const candidates = slotState.candidates
          .slice()
          .sort((a, b) => {
            const aSet = (slotState.slots || []).some((s) => s.nodeId === a.id);
            const bSet = (slotState.slots || []).some((s) => s.nodeId === b.id);
            if (aSet && !bSet) return -1;
            if (!aSet && bSet) return 1;
            return (a.name || '').localeCompare(b.name || '');
          })
          .filter((cand) => {
            if (!slotFilter) return true;
            const text = `${cand.name} ${cand.preview || ''}`.toLowerCase();
            return text.includes(slotFilter);
          });

        const rows = candidates.map((cand) => {
          const row = document.createElement('div');
          row.className = 'slot-row';
          row.style.display = 'contents';

          const label = document.createElement('div');
          const fontInfo = cand.fontSize ? ` · ${cand.fontSize}px` : '';
          label.textContent = `${cand.name} (${cand.type})${fontInfo}${cand.preview ? ' · ' + cand.preview : ''}`;

          const slotType = document.createElement('select');
          const emptyOpt = document.createElement('option');
          emptyOpt.value = '';
          emptyOpt.textContent = '不使用';
          slotType.appendChild(emptyOpt);
          SLOT_TYPES.forEach((st) => {
            const opt = document.createElement('option');
            opt.value = st;
            opt.textContent = st;
            slotType.appendChild(opt);
          });

          const dataTypeSelect = document.createElement('select');
          const emptyDt = document.createElement('option');
          emptyDt.value = '';
          emptyDt.textContent = '默认';
          dataTypeSelect.appendChild(emptyDt);
          DATA_TYPES.forEach((dt) => {
            const opt = document.createElement('option');
            opt.value = dt;
            opt.textContent = dt;
            dataTypeSelect.appendChild(opt);
          });

          const slotName = document.createElement('input');
          slotName.className = 'meta-input';
          slotName.placeholder = 'slot 名称';

          const existing = (slotState.slots || []).find((s) => s.nodeId === cand.id);
          if (existing) {
            slotType.value = existing.slotType || '';
            dataTypeSelect.value = existing.dataType || '';
            slotName.value = existing.slotName || cand.name;
          } else {
            slotName.value = cand.name;
          }

          row.appendChild(label);
          row.appendChild(slotType);
          row.appendChild(dataTypeSelect);
          row.appendChild(slotName);

          return { row, slotType, dataTypeSelect, slotName, cand };
        });

        rows.forEach((r) => {
          grid.appendChild(r.row);
        });
        panel.appendChild(grid);

        const actions = document.createElement('div');
        actions.className = 'row';
        actions.style.justifyContent = 'space-between';
        actions.style.marginTop = '8px';
        const resetBtn = document.createElement('button');
        resetBtn.textContent = '清空选择';
        resetBtn.onclick = () => {
          slotState.slots = [];
          renderSlots();
        };
        const saveBtn = document.createElement('button');
        saveBtn.textContent = '保存插槽';
        saveBtn.onclick = () => {
          const slots = rows
            .map((r) => {
              if (!r.slotType.value) return null;
              return {
                slotName: r.slotName.value || r.cand.name,
                nodeId: r.cand.id,
                slotType: r.slotType.value,
                dataType: r.dataTypeSelect.value || undefined
              };
            })
            .filter(Boolean);
          parent.postMessage(
            { pluginMessage: { type: 'save-slots', id: slotState.componentId, slots } },
            '*'
          );
          slotState.slots = slots;
          renderSlots();
        };
        actions.appendChild(resetBtn);
        actions.appendChild(saveBtn);
        panel.appendChild(actions);
      };
    </script>
  </body>
</html>
