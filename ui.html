<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>LLM Canvas Demo</title>
    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        margin: 8px;
        font-size: 12px;
      }
      label {
        display: block;
        margin-bottom: 4px;
        font-weight: 600;
      }
      input,
      select,
      textarea {
        width: 100%;
        box-sizing: border-box;
        padding: 4px 6px;
        font-size: 12px;
      }
      button {
        margin-top: 8px;
        width: 100%;
        padding: 6px 0;
      }
      .row {
        display: flex;
        gap: 8px;
      }
      .row button {
        width: auto;
        margin-top: 0;
      }
      .lib {
        margin-top: 8px;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        padding: 8px;
        background: #fafafa;
      }
      .lib-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 4px;
        font-weight: 600;
      }
      .lib-header button {
        width: auto;
        margin-top: 0;
        padding: 4px 8px;
      }
      .lib-header .right {
        display: flex;
        gap: 6px;
      }
      .meta-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 6px;
        margin-top: 4px;
      }
      .meta-grid textarea {
        height: 50px;
        font-size: 12px;
      }
      .tag-input,
      .meta-input {
        width: 100%;
        box-sizing: border-box;
        font-size: 12px;
        padding: 4px 6px;
      }
      .chip-row {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
      }
      .chip {
        border: 1px solid #e5e7eb;
        border-radius: 4px;
        padding: 2px 6px;
        font-size: 11px;
        background: #f3f4f6;
        cursor: pointer;
      }
      .chip.selected {
        background: #e0f2fe;
        border-color: #7dd3fc;
      }
      .slot-panel {
        margin-top: 8px;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        padding: 8px;
        background: #fff;
      }
      .slot-grid {
        display: grid;
        grid-template-columns: 1.3fr 140px 140px 180px;
        gap: 6px;
        align-items: center;
      }
      .slot-header {
        font-weight: 600;
        margin-bottom: 6px;
      }
      .slot-row {
        font-size: 12px;
      }
      .slot-summary {
        font-size: 12px;
        color: #374151;
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .slot-hint {
        font-size: 11px;
        color: #6b7280;
        margin: 4px 0;
      }
      .slot-filter {
        width: 100%;
        box-sizing: border-box;
        margin: 6px 0;
        padding: 4px 6px;
        font-size: 12px;
      }
      .badge {
        display: inline-block;
        padding: 2px 6px;
        font-size: 11px;
        border-radius: 4px;
        border: 1px solid #e5e7eb;
        background: #f3f4f6;
      }
      .badge.accent {
        border-color: #7dd3fc;
        background: #e0f2fe;
      }
      .lib-list {
        max-height: 180px;
        overflow: auto;
        display: grid;
        gap: 6px;
      }
      .lib-item {
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        padding: 6px;
        background: #fff;
      }
      .lib-meta {
        font-size: 11px;
        color: #6b7280;
        margin-top: 2px;
      }
      .lib-note {
        margin-top: 4px;
        font-size: 12px;
        width: 100%;
      }
      .lib-actions {
        text-align: right;
      }
      .status {
        margin-top: 6px;
        min-height: 16px;
        color: #374151;
      }
      .op-list {
        margin-top: 6px;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        padding: 6px;
        background: #fff;
        font-size: 11px;
        max-height: 140px;
        overflow: auto;
      }
      .op-item {
        padding: 2px 0;
        border-bottom: 1px solid #f3f4f6;
      }
      .op-item:last-child {
        border-bottom: none;
      }
      .tabs {
        display: flex;
        gap: 6px;
        margin-bottom: 8px;
      }
      .tab-btn {
        border: 1px solid #e5e7eb;
        background: #f3f4f6;
        border-radius: 8px;
        padding: 6px 10px;
        cursor: pointer;
        font-size: 12px;
      }
      .tab-btn.active {
        background: #e0f2fe;
        border-color: #7dd3fc;
        font-weight: 600;
      }
      .tab-panel {
        display: none;
      }
      .tab-panel.active {
        display: block;
      }
      .req-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 6px;
      }
      .exp-list {
        display: grid;
        gap: 6px;
        margin-top: 6px;
      }
      .exp-item {
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        padding: 8px;
        background: #fff;
        display: grid;
        grid-template-columns: 18px 1fr;
        gap: 8px;
        align-items: flex-start;
      }
      .exp-title {
        font-weight: 600;
      }
      .exp-desc {
        font-size: 11px;
        color: #4b5563;
        margin-top: 2px;
      }
      .exp-meta {
        font-size: 11px;
        color: #6b7280;
        margin-top: 2px;
      }
      .exp-empty {
        color: #6b7280;
        font-size: 12px;
        border: 1px dashed #e5e7eb;
        background: #fafafa;
        padding: 8px;
        border-radius: 6px;
      }
      .req-list {
        max-height: 200px;
        overflow: auto;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        background: #fff;
      }
      .req-item {
        padding: 6px;
        border-bottom: 1px solid #f3f4f6;
        cursor: pointer;
      }
      .req-item:hover {
        background: #f9fafb;
      }
      .req-item.active {
        background: #e0f2fe;
      }
      .pill {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 11px;
        background: #f3f4f6;
        margin-right: 4px;
      }
      .priority-list {
        max-height: 200px;
        overflow: auto;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        background: #fff;
        padding: 6px;
      }
      .priority-row {
        display: grid;
        grid-template-columns: 48px 80px 1fr 1fr;
        gap: 6px;
        align-items: center;
        padding: 4px 0;
        border-bottom: 1px solid #f3f4f6;
      }
      .priority-row:last-child {
        border-bottom: none;
      }
      .small-input {
        width: 100%;
        box-sizing: border-box;
        font-size: 12px;
        padding: 4px 6px;
      }
      .export-block {
        margin-top: 6px;
        display: none;
      }
      .export-block textarea {
        width: 100%;
        box-sizing: border-box;
        height: 100px;
        font-size: 11px;
      }
      .section {
        margin-top: 10px;
        padding: 8px;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        background: #fafafa;
      }
      .section h3 {
        margin: 0 0 6px 0;
        font-size: 13px;
      }
      .summary {
        font-size: 11px;
        color: #6b7280;
      }
      .summary span {
        display: inline-block;
        margin-right: 8px;
      }
      .two-col {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }
      textarea.small {
        height: 80px;
      }
      .status {
        margin-top: 6px;
        min-height: 16px;
        color: #374151;
      }
    </style>
  </head>
  <body>
    <div class="tabs">
      <button class="tab-btn active" data-tab="generateTab">生成 / 配置</button>
      <button class="tab-btn" data-tab="experimentTab">实验模式</button>
      <button class="tab-btn" data-tab="editTab">UI 编辑</button>
    </div>

    <div id="generateTab" class="tab-panel active">
      <div class="section">
        <h3>组件库</h3>
        <div class="lib-header">
          <button id="import">导入选中 Section</button>
          <div class="right">
            <button id="enrich">AI 推荐元数据</button>
            <button id="export">导出 JSON</button>
          </div>
        </div>
        <div id="library-list" class="lib-list"></div>
        <div id="exportWrap" class="export-block">
          <div class="row" style="justify-content: space-between; align-items: center">
            <span class="summary">已生成 JSON，可复制</span>
            <button id="copyExport">复制</button>
          </div>
          <textarea id="exportText" readonly></textarea>
        </div>
      </div>

      <div class="section">
        <h3>需求文档</h3>
        <textarea id="docText" class="small" placeholder="粘贴需求文档，用于解析阶段/角色/信息项/页面"></textarea>
        <div class="row" style="margin-top: 6px; align-items: center">
          <button id="parseDoc">解析文档</button>
          <div class="summary" id="reqSummary"></div>
        </div>
      </div>

      <div class="section">
        <h3>解析结果</h3>
        <div class="req-grid">
          <div>
            <div class="summary">页面列表</div>
            <div id="pageList" class="req-list"></div>
            <div class="summary" style="margin-top: 6px">可多选页面</div>
            <div style="margin-top: 6px">
              <label>布局模板</label>
              <select id="templateSelect" style="width: 100%; padding: 4px 6px; font-size: 12px;">
                <option value="two-col">双列</option>
                <option value="three-col">三列</option>
                <option value="main-side">主+侧</option>
                <option value="dashboard">仪表盘</option>
              </select>
            </div>
            <button id="generatePages" style="margin-top: 6px">生成所选页面</button>
          </div>
          <div>
            <div class="summary">信息项优先级（选中页面）</div>
            <div id="pageInfo" class="priority-list"></div>
            <div class="row" style="justify-content: flex-end; margin-top: 6px">
              <button id="recommendBindings">AI 推荐组件</button>
            </div>
          </div>
        </div>
        <div class="summary" style="margin-top: 6px">
          <span>高优先级 ≤ 1 项</span>
          <span style="margin-left: 8px">中优先级 ≤ 4 项</span>
        </div>
        <button id="saveRequirement" style="margin-top: 6px">保存解析结果</button>
      </div>

      <div class="section">
        <h3>生成设置</h3>
        <div class="two-col">
          <div>
            <label>模型提供商</label>
            <select id="provider">
              <option value="siliconflow">SiliconFlow（OpenAI兼容）</option>
              <option value="openai">OpenAI</option>
              <option value="gemini">Gemini</option>
            </select>
          </div>
          <div>
            <label>指令（自然语言）</label>
            <textarea
              id="prompt"
              rows="3"
              placeholder="例如：生成“姿态监控-正常飞行”页面"
            ></textarea>
          </div>
        </div>
        <div class="row" style="align-items: center; margin-top: 8px">
          <label style="margin: 0; display: flex; align-items: center; gap: 4px">
            <input id="useLibrary" type="checkbox" checked />
            生成时参考组件库
          </label>
          <button id="run">生成到画布</button>
        </div>
      </div>
      <div id="status" class="status"></div>
    </div>

    <div id="experimentTab" class="tab-panel">
      <div class="section">
        <h3>实验模式</h3>
        <div class="summary">选择预设场景，一键加载需求模型与组件库</div>
        <div id="experimentList" class="exp-list"></div>
        <div class="row" style="margin-top: 8px; justify-content: space-between; align-items: center">
          <div id="experimentStatus" class="summary"></div>
          <button id="loadExperimentBtn" style="width: auto">加载场景</button>
        </div>
      </div>
    </div>

    <div id="editTab" class="tab-panel">
      <div class="section">
        <h3>UI 编辑（单页面）</h3>
        <div class="summary">先在画布选中要编辑的 Frame，然后输入自然语言指令</div>
        <div class="two-col" style="margin-top: 6px">
          <div>
            <label>模型提供商</label>
            <select id="editProvider">
              <option value="siliconflow">SiliconFlow（OpenAI兼容）</option>
              <option value="openai">OpenAI</option>
              <option value="gemini">Gemini</option>
            </select>
          </div>
          <div>
            <label>API Key（可选）</label>
            <input id="editApiKey" type="password" placeholder="留空则使用服务端配置" />
          </div>
        </div>
        <label style="margin-top: 6px; display: block">编辑指令</label>
        <textarea
          id="editPrompt"
          rows="3"
          placeholder="例如：把过滤条调整到顶部，并增加一个两列布局的告警摘要卡片"
        ></textarea>
        <div class="row" style="margin-top: 8px; justify-content: space-between; align-items: center">
          <button id="applyEdit" style="width: auto">应用到所选页面</button>
          <button id="undoEdit" style="width: auto">撤销上一次编辑</button>
        </div>
        <div id="editStatus" class="status"></div>
        <div id="editOpsList" class="op-list"></div>
      </div>
    </div>

    <script>
      const runButton = document.getElementById('run');
      const statusEl = document.getElementById('status');
      const importBtn = document.getElementById('import');
      const exportBtn = document.getElementById('export');
      const enrichBtn = document.getElementById('enrich');
      const libraryListEl = document.getElementById('library-list');
      const useLibraryEl = document.getElementById('useLibrary');
      const docTextEl = document.getElementById('docText');
      const parseDocBtn = document.getElementById('parseDoc');
      const reqSummaryEl = document.getElementById('reqSummary');
      const providerEl = document.getElementById('provider');
      const promptEl = document.getElementById('prompt');
      const exportWrap = document.getElementById('exportWrap');
      const exportText = document.getElementById('exportText');
      const copyExportBtn = document.getElementById('copyExport');
      const pageListEl = document.getElementById('pageList');
      const pageInfoEl = document.getElementById('pageInfo');
      const saveReqBtn = document.getElementById('saveRequirement');
      const recommendBtn = document.getElementById('recommendBindings');
      const templateSelect = document.getElementById('templateSelect');
      const generatePagesBtn = document.getElementById('generatePages');
      const editPromptEl = document.getElementById('editPrompt');
      const editProviderEl = document.getElementById('editProvider');
      const editApiKeyEl = document.getElementById('editApiKey');
      const applyEditBtn = document.getElementById('applyEdit');
      const undoEditBtn = document.getElementById('undoEdit');
      const editStatusEl = document.getElementById('editStatus');
      const editOpsList = document.getElementById('editOpsList');
      const tabButtons = Array.from(document.querySelectorAll('.tab-btn'));
      const tabPanels = {
        generateTab: document.getElementById('generateTab'),
        experimentTab: document.getElementById('experimentTab'),
        editTab: document.getElementById('editTab')
      };
      const experimentListEl = document.getElementById('experimentList');
      const loadExperimentBtn = document.getElementById('loadExperimentBtn');
      const experimentStatusEl = document.getElementById('experimentStatus');
      let library = [];
      let requirement = null;
      let experiments = [];
      let slotState = null;
      let slotFilter = '';
      let selectedPageId = null;
      const selectedPageIds = new Set();
      let selectedExperimentId = null;
      let experimentLoading = false;
      let loadedExperimentName = '';
      const DATA_TYPES = ['numeric', 'trend', 'alert', 'state', 'text', 'map', 'list'];
      const SLOT_TYPES = ['label', 'numericValue', 'unit', 'state', 'alert', 'listItem'];

      const setLoading = (isLoading) => {
        runButton.disabled = isLoading;
        runButton.textContent = isLoading ? '生成中…' : '生成到画布';
        if (isLoading) {
          statusEl.textContent = '正在生成，请稍候…';
        } else if (statusEl.dataset.state !== 'success') {
          statusEl.textContent = '';
        }
        statusEl.dataset.state = isLoading ? 'loading' : statusEl.dataset.state;
      };

      const setEditLoading = (isLoading) => {
        applyEditBtn.disabled = isLoading;
        undoEditBtn.disabled = isLoading;
        if (isLoading) {
          editStatusEl.textContent = '正在生成编辑方案…';
          editStatusEl.dataset.state = 'loading';
        }
      };

      const setExperimentLoading = (isLoading) => {
        experimentLoading = isLoading;
        if (loadExperimentBtn) {
          loadExperimentBtn.disabled = isLoading || !selectedExperimentId;
          loadExperimentBtn.textContent = isLoading ? '加载中…' : '加载场景';
        }
      };

      const renderExperiments = () => {
        if (!experimentListEl) return;
        experimentListEl.innerHTML = '';
        if (!experiments.length) {
          const empty = document.createElement('div');
          empty.className = 'exp-empty';
          empty.textContent = '当前无可用实验场景';
          experimentListEl.appendChild(empty);
          if (loadExperimentBtn) loadExperimentBtn.disabled = true;
          return;
        }
        if (!selectedExperimentId) {
          selectedExperimentId = experiments[0].id;
        }
        experiments.forEach((exp) => {
          const row = document.createElement('label');
          row.className = 'exp-item';
          const radio = document.createElement('input');
          radio.type = 'radio';
          radio.name = 'experiment';
          radio.value = exp.id;
          radio.checked = exp.id === selectedExperimentId;
          radio.onchange = () => {
            selectedExperimentId = exp.id;
            setExperimentLoading(false);
            renderExperiments();
          };

          const body = document.createElement('div');
          const title = document.createElement('div');
          title.className = 'exp-title';
          title.textContent = exp.name || exp.id;
          const desc = document.createElement('div');
          desc.className = 'exp-desc';
          desc.textContent = exp.description || '无描述';
          const meta = document.createElement('div');
          meta.className = 'exp-meta';
          meta.textContent = `ID: ${exp.id}`;
          body.appendChild(title);
          body.appendChild(desc);
          body.appendChild(meta);

          row.appendChild(radio);
          row.appendChild(body);
          experimentListEl.appendChild(row);
        });
        if (loadExperimentBtn) {
          loadExperimentBtn.disabled = experimentLoading || !selectedExperimentId;
          loadExperimentBtn.textContent = experimentLoading ? '加载中…' : '加载场景';
        }
        if (experimentStatusEl && loadedExperimentName) {
          experimentStatusEl.textContent = `已加载：${loadedExperimentName}`;
        }
      };

      const renderEditOps = (ops = [], summary = '') => {
        if (!editOpsList) return;
        editOpsList.innerHTML = '';
        if (summary) {
          const s = document.createElement('div');
          s.className = 'op-item';
          s.textContent = summary;
          editOpsList.appendChild(s);
        }
        if (!ops.length && !summary) {
          editOpsList.textContent = '暂无操作记录';
          return;
        }
        ops.forEach((item) => {
          const row = document.createElement('div');
          row.className = 'op-item';
          row.textContent = `${item.op || ''} · ${item.detail || ''}`;
          editOpsList.appendChild(row);
        });
      };

      const switchTab = (tabId) => {
        tabButtons.forEach((btn) => {
          btn.classList.toggle('active', btn.dataset.tab === tabId);
        });
        Object.entries(tabPanels).forEach(([id, panel]) => {
          if (panel) panel.classList.toggle('active', id === tabId);
        });
      };

      tabButtons.forEach((btn) => {
        btn.onclick = () => switchTab(btn.dataset.tab);
      });

      if (editProviderEl && providerEl) {
        editProviderEl.value = providerEl.value;
      }

      const renderLibrary = () => {
        libraryListEl.innerHTML = '';
        if (!library.length) {
          libraryListEl.textContent = '暂无组件，选中 Section 后点击“导入”';
          useLibraryEl.checked = false;
          useLibraryEl.disabled = true;
          return;
        }
        useLibraryEl.disabled = false;
        if (useLibraryEl.dataset.userToggled !== 'true') {
          useLibraryEl.checked = true;
        }

        library.forEach((item) => {
          const wrapper = document.createElement('div');
          wrapper.className = 'lib-item';
          const titleRow = document.createElement('div');
          titleRow.style.display = 'flex';
          titleRow.style.justifyContent = 'space-between';
          titleRow.style.alignItems = 'center';

          const nameInput = document.createElement('input');
          nameInput.className = 'meta-input';
          nameInput.value = item.name || '';
          nameInput.placeholder = '组件名称';
          nameInput.onchange = () => updateComponentMeta(item.id, { name: nameInput.value });

          const actions = document.createElement('div');
          actions.className = 'lib-actions';
          const slotBtn = document.createElement('button');
          slotBtn.textContent = '配置插槽';
          slotBtn.onclick = () => {
            parent.postMessage({ pluginMessage: { type: 'request-slots', id: item.id } }, '*');
          };
          const removeBtn = document.createElement('button');
          removeBtn.textContent = '移除';
          removeBtn.onclick = () => {
            parent.postMessage({ pluginMessage: { type: 'remove-component', id: item.id } }, '*');
          };
          actions.appendChild(slotBtn);
          actions.appendChild(removeBtn);

          titleRow.appendChild(nameInput);
          titleRow.appendChild(actions);

          const meta = document.createElement('div');
          meta.className = 'lib-meta';
          meta.textContent = `${Math.round(item.width)}x${Math.round(item.height)}${
            item.primaryColor ? ` | 主色:${item.primaryColor}` : ''
          }${item.sampleText ? ` | 文案:${item.sampleText}` : ''}`;

          const metaGrid = document.createElement('div');
          metaGrid.className = 'meta-grid';

          const desc = document.createElement('textarea');
          desc.placeholder = '描述';
          desc.value = item.description || '';
          desc.onchange = () => updateComponentMeta(item.id, { description: desc.value });

          const tags = document.createElement('input');
          tags.className = 'tag-input';
          tags.placeholder = '标签，逗号分隔';
          tags.value = (item.tags || []).join(', ');
          tags.onchange = () => {
            const values = tags.value
              .split(',')
              .map((v) => v.trim())
              .filter(Boolean);
            updateComponentMeta(item.id, { tags: values });
          };

          metaGrid.appendChild(desc);
          metaGrid.appendChild(tags);

          const chipRow = document.createElement('div');
          chipRow.className = 'chip-row';
          DATA_TYPES.forEach((dt) => {
            const chip = document.createElement('div');
            chip.className = 'chip';
            chip.textContent = dt;
            const selected = item.supportedDataTypes?.includes(dt);
            if (selected) chip.classList.add('selected');
            chip.onclick = () => {
              const next = new Set(item.supportedDataTypes || []);
              if (next.has(dt)) {
                next.delete(dt);
              } else {
                next.add(dt);
              }
              updateComponentMeta(item.id, { supportedDataTypes: Array.from(next) });
            };
            chipRow.appendChild(chip);
          });

          const note = document.createElement('textarea');
          note.className = 'lib-note';
          note.rows = 2;
          note.placeholder = '备注 / 用途说明';
          note.value = item.note || '';
          note.onchange = () => {
            parent.postMessage(
              { pluginMessage: { type: 'update-note', id: item.id, note: note.value } },
              '*'
            );
          };

          wrapper.appendChild(titleRow);
          wrapper.appendChild(meta);
          wrapper.appendChild(metaGrid);
          const dataTypeLabel = document.createElement('div');
          dataTypeLabel.className = 'summary';
          dataTypeLabel.textContent = '支持的数据类型';
          wrapper.appendChild(dataTypeLabel);
          wrapper.appendChild(chipRow);
          wrapper.appendChild(note);
          libraryListEl.appendChild(wrapper);
        });
      };

      runButton.onclick = () => {
        const prompt = promptEl.value;
        const provider = providerEl.value;
        const useLibrary = useLibraryEl.checked;

        setLoading(true);

        parent.postMessage(
          {
            pluginMessage: {
              type: 'generate-design',
              prompt,
              apiKey: '', // API Key 交由后端管理
              provider,
              useLibrary
            }
          },
          '*'
        );
      };

      importBtn.onclick = () => {
        parent.postMessage({ pluginMessage: { type: 'import-section' } }, '*');
      };

      exportBtn.onclick = () => {
        parent.postMessage({ pluginMessage: { type: 'export-library' } }, '*');
      };

      enrichBtn.onclick = () => {
        statusEl.textContent = '向 AI 请求元数据推荐…';
        parent.postMessage({ pluginMessage: { type: 'enrich-library' } }, '*');
      };

      parseDocBtn.onclick = () => {
        const docText = docTextEl.value;
        parent.postMessage({ pluginMessage: { type: 'parse-doc', docText } }, '*');
      };

      if (loadExperimentBtn) {
        loadExperimentBtn.onclick = () => {
          if (!selectedExperimentId || experimentLoading) return;
          setExperimentLoading(true);
          if (experimentStatusEl) experimentStatusEl.textContent = '加载中…';
          parent.postMessage(
            { pluginMessage: { type: 'load-experiment', experimentId: selectedExperimentId } },
            '*'
          );
        };
      }

      saveReqBtn.onclick = () => {
        if (!requirement) return;
        parent.postMessage({ pluginMessage: { type: 'update-requirement', data: requirement } }, '*');
        statusEl.textContent = '已保存解析结果';
        statusEl.dataset.state = 'success';
      };

      recommendBtn.onclick = () => {
        if (!selectedPageId) {
          statusEl.textContent = '请先选择页面';
          statusEl.dataset.state = 'error';
          return;
        }
        statusEl.textContent = '向 AI 请求组件推荐…';
        parent.postMessage({ pluginMessage: { type: 'recommend-bindings', pageId: selectedPageId } }, '*');
      };

      generatePagesBtn.onclick = () => {
        if (!selectedPageIds.size) {
          statusEl.textContent = '请选择至少一个页面';
          statusEl.dataset.state = 'error';
          return;
        }
        const pageIds = Array.from(selectedPageIds);
        const template = templateSelect.value || 'two-col';
        parent.postMessage({
          pluginMessage: { type: 'generate-pages', pageIds, template, useLibrary: true }
        }, '*');
        statusEl.textContent = `生成 ${pageIds.length} 个页面中…`;
        statusEl.dataset.state = 'loading';
      };

      applyEditBtn.onclick = () => {
        const prompt = (editPromptEl.value || '').trim();
        if (!prompt) {
          editStatusEl.textContent = '请输入编辑指令';
          editStatusEl.dataset.state = 'error';
          return;
        }
        parent.postMessage(
          {
            pluginMessage: {
              type: 'edit-page',
              prompt,
              provider: editProviderEl.value,
              apiKey: (editApiKeyEl.value || '').trim()
            }
          },
          '*'
        );
        setEditLoading(true);
      };

      undoEditBtn.onclick = () => {
        parent.postMessage({ pluginMessage: { type: 'undo-edit' } }, '*');
      };

      useLibraryEl.onchange = () => {
        useLibraryEl.dataset.userToggled = 'true';
      };

      const updateRequirementSummary = (keepSelection = true) => {
        if (!requirement) {
          reqSummaryEl.textContent = '未解析';
          return;
        }
        const { phases = [], roles = [], conditions = [], infoItems = [], pages = [] } = requirement;
        reqSummaryEl.innerHTML = `
          <span>阶段:${phases.length}</span>
          <span>角色:${roles.length}</span>
          <span>条件:${conditions.length}</span>
          <span>信息项:${infoItems.length}</span>
          <span>页面:${pages.length}</span>
        `;
        renderPageList(keepSelection);
      };

      const renderPageList = (keepSelection = true) => {
        pageListEl.innerHTML = '';
        if (!requirement?.pages?.length) {
          pageListEl.textContent = '暂无解析结果';
          pageInfoEl.innerHTML = '';
          selectedPageId = null;
          return;
        }
        const prevSelected = keepSelection ? selectedPageId : null;
        requirement.pages.forEach((page) => {
          const row = document.createElement('div');
          row.className = 'req-item';
          if (selectedPageIds.has(page.id)) row.classList.add('active');
          const phase = requirement.phases?.find((p) => p.id === page.phaseId);
          const role = requirement.roles?.find((r) => r.id === page.roleId);
          const cond = requirement.conditions?.find((c) => c.id === page.conditionId);
          row.innerHTML = `
            <div>${page.name || '未命名页面'}</div>
            <div class="summary">
              <span class="pill">${phase?.name || 'Phase'}</span>
              <span class="pill">${role?.name || 'Role'}</span>
              <span class="pill">${cond?.name || 'Condition'}</span>
            </div>
          `;
          row.onclick = () => {
            if (selectedPageIds.has(page.id)) {
              selectedPageIds.delete(page.id);
            } else {
              selectedPageIds.add(page.id);
            }
            selectedPageId = page.id;
            renderPageList();
            renderPageInfo(page);
          };
          pageListEl.appendChild(row);
        });
        if (!selectedPageId && requirement.pages.length) {
          selectedPageId = requirement.pages[0].id;
          selectedPageIds.add(selectedPageId);
        }
        if (selectedPageId) {
          const current = requirement.pages.find((p) => p.id === selectedPageId) || requirement.pages[0];
          selectedPageId = current?.id || null;
          if (selectedPageId) renderPageInfo(current);
        }
      };

      const renderPageInfo = (page) => {
        pageInfoEl.innerHTML = '';
        if (!page?.infoPriorities?.length) {
          pageInfoEl.textContent = '无信息项';
          return;
        }
        const rows = page.infoPriorities
          .slice()
          .sort((a, b) => a.priority - b.priority)
          .map((item) => {
            const info = requirement.infoItems?.find((x) => x.id === item.infoItemId);
            const row = document.createElement('div');
            row.className = 'priority-row';

            const tier = getTier(item);

            const tierSelect = document.createElement('select');
            ['high', 'medium', 'low'].forEach((t) => {
              const opt = document.createElement('option');
              opt.value = t;
              opt.textContent = t;
              tierSelect.appendChild(opt);
            });
            tierSelect.value = tier;

            tierSelect.onchange = () => {
              const nextTier = tierSelect.value;
              if (!canAssignTier(page, item, nextTier)) {
                statusEl.textContent = '高优先级 ≤1，中优先级 ≤4，请调整';
                statusEl.dataset.state = 'error';
                tierSelect.value = tier;
                return;
              }
              setTier(item, nextTier);
              renderPageInfo(page);
              statusEl.textContent = '';
            };

            const nameInput = document.createElement('input');
            nameInput.className = 'small-input';
            nameInput.value = info?.name || item.infoItemId;
            nameInput.onchange = () => {
              if (info) info.name = nameInput.value;
            };

            const noteInput = document.createElement('input');
            noteInput.className = 'small-input';
            noteInput.placeholder = '备注';
            noteInput.value = item.note || '';
            noteInput.onchange = () => {
              item.note = noteInput.value;
            };

            const bindingSelect = document.createElement('select');
            const noneOpt = document.createElement('option');
            noneOpt.value = '';
            noneOpt.textContent = '未绑定组件';
            bindingSelect.appendChild(noneOpt);
            library.forEach((comp) => {
              const opt = document.createElement('option');
              opt.value = comp.id;
              opt.textContent = comp.name;
              bindingSelect.appendChild(opt);
            });
            const currentBinding = (page.preferredBindings || []).find(
              (b) => b.infoItemId === item.infoItemId
            );
            bindingSelect.value = currentBinding?.componentId || '';
            bindingSelect.onchange = () => {
              setBinding(page, item.infoItemId, bindingSelect.value);
            };

            row.appendChild(tierSelect);
            row.appendChild(nameInput);
            row.appendChild(noteInput);
            row.appendChild(bindingSelect);
            return row;
          });
        rows.forEach((r) => pageInfoEl.appendChild(r));
      };

      copyExportBtn.onclick = () => {
        if (!exportText.value) return;
        exportText.select();
        document.execCommand('copy');
        statusEl.textContent = '已复制到剪贴板';
        statusEl.dataset.state = 'success';
      };

      const getTier = (item) => {
        if (item.tier) return item.tier;
        if (item.priority <= 1) return 'high';
        if (item.priority <= 5) return 'medium';
        return 'low';
      };

      const setTier = (item, tier) => {
        item.tier = tier;
        if (tier === 'high') item.priority = 1;
        else if (tier === 'medium') item.priority = 5;
        else item.priority = 9;
      };

      const setBinding = (page, infoItemId, componentId) => {
        const bindings = page.preferredBindings || [];
        const found = bindings.find((b) => b.infoItemId === infoItemId);
        if (found) {
          found.componentId = componentId || undefined;
        } else {
          bindings.push({ infoItemId, componentId: componentId || undefined });
        }
        page.preferredBindings = bindings;
      };

      const canAssignTier = (page, currentItem, nextTier) => {
        const counts = { high: 0, medium: 0, low: 0 };
        page.infoPriorities.forEach((it) => {
          const t = it === currentItem ? nextTier : getTier(it);
          counts[t] += 1;
        });
        if (counts.high > 1) return false;
        if (counts.medium > 4) return false;
        return true;
      };

      // Request library & requirement on load
      parent.postMessage({ pluginMessage: { type: 'request-library' } }, '*');
      parent.postMessage({ pluginMessage: { type: 'request-requirement' } }, '*');
      renderEditOps([], '');
      renderExperiments();

      window.onmessage = (event) => {
        const msg = event.data.pluginMessage;
        if (!msg) return;

        if (msg.type === 'experiments-list') {
          experiments = Array.isArray(msg.items) ? msg.items : [];
          const prevSelected = selectedExperimentId;
          selectedExperimentId =
            experiments.find((e) => e.id === prevSelected)?.id ||
            (experiments[0] ? experiments[0].id : null);
          if (experimentStatusEl) {
            if (msg.error) {
              experimentStatusEl.textContent = `加载失败：${msg.error}`;
            } else if (experiments.length) {
              experimentStatusEl.textContent = `已同步 ${experiments.length} 个场景`;
            } else {
              experimentStatusEl.textContent = '当前无可用实验场景';
            }
          }
          setExperimentLoading(false);
          renderExperiments();
          return;
        }

        if (msg.type === 'experiment-loaded') {
          loadedExperimentName = msg.name || msg.id;
          setExperimentLoading(false);
          if (experimentStatusEl) {
            experimentStatusEl.textContent = `已加载场景：${loadedExperimentName}`;
          }
          return;
        }

        if (msg.type === 'load-experiment-error') {
          setExperimentLoading(false);
          if (experimentStatusEl) {
            experimentStatusEl.textContent = `加载失败：${msg.message || '请稍后重试'}`;
          }
          return;
        }

        if (msg.type === 'library') {
          library = msg.items || [];
          renderLibrary();
          return;
        }

        if (msg.type === 'slots') {
          slotState = {
            componentId: msg.componentId,
            candidates: msg.candidates || [],
            slots: msg.slots || []
          };
          renderSlots();
          return;
        }

        if (msg.type === 'library-export') {
          const json = JSON.stringify(msg.data, null, 2);
          exportText.value = json;
          exportWrap.style.display = 'block';
          try {
            if (navigator.clipboard) {
              navigator.clipboard.writeText(json).catch(() => {});
            }
          } catch (_error) {
            // ignore clipboard errors
          }
          statusEl.textContent = '已导出组件库 JSON，下方可复制';
          statusEl.dataset.state = 'success';
          return;
        }

        if (msg.type === 'library-enriched') {
          statusEl.textContent = `已应用 ${msg.applied || 0} 个组件的推荐`;
          statusEl.dataset.state = 'success';
          return;
        }

        if (msg.type === 'requirement') {
          requirement = msg.data;
          updateRequirementSummary(true);
          return;
        }

        if (msg.type === 'edit-ops') {
          renderEditOps(msg.operations || [], msg.summary || '');
          return;
        }

        if (msg.type === 'edit-status') {
          if (msg.state === 'loading') {
            setEditLoading(true);
            editStatusEl.textContent = msg.message || '正在编辑…';
            editStatusEl.dataset.state = 'loading';
          } else {
            setEditLoading(false);
          }

          if (msg.state === 'error') {
            editStatusEl.dataset.state = 'error';
            editStatusEl.textContent = `错误：${msg.message || '编辑失败'}`;
          } else if (msg.state === 'success') {
            editStatusEl.dataset.state = 'success';
            editStatusEl.textContent = msg.message || '编辑完成';
            setTimeout(() => {
              if (editStatusEl.dataset.state === 'success') {
                editStatusEl.textContent = '';
                editStatusEl.dataset.state = '';
              }
            }, 1500);
          } else if (
            msg.state === 'idle' &&
            editStatusEl.dataset.state !== 'error' &&
            editStatusEl.dataset.state !== 'success'
          ) {
            editStatusEl.dataset.state = '';
            editStatusEl.textContent = '';
          }
          return;
        }

        if (msg.type === 'status') {
          if (msg.state === 'loading') {
            setLoading(true);
          } else {
            setLoading(false);
          }

          if (msg.state === 'error') {
            statusEl.dataset.state = 'error';
            statusEl.textContent = `错误：${msg.message || '生成失败'}`;
          } else if (msg.state === 'success') {
            statusEl.dataset.state = 'success';
            statusEl.textContent = '生成完成';
            setTimeout(() => {
              if (statusEl.dataset.state === 'success') {
                statusEl.textContent = '';
                statusEl.dataset.state = '';
              }
            }, 1500);
          } else if (msg.state === 'idle' && statusEl.dataset.state !== 'error') {
            statusEl.dataset.state = '';
            statusEl.textContent = '';
          }
        }
      };

      const renderSlots = () => {
        const panelId = 'slotPanel';
        let panel = document.getElementById(panelId);
        if (!slotState) {
          if (panel) panel.remove();
          return;
        }
        if (!panel) {
          panel = document.createElement('div');
          panel.id = panelId;
          panel.className = 'slot-panel';
          libraryListEl.parentNode.appendChild(panel);
        }
        panel.innerHTML = '';

        const header = document.createElement('div');
        header.className = 'slot-header';
        const comp = library.find((c) => c.id === slotState.componentId);
        header.textContent = `插槽配置：${comp?.name || slotState.componentId}`;
        panel.appendChild(header);

        const summary = document.createElement('div');
        summary.className = 'slot-summary';
        const configuredCount = slotState.slots?.length || 0;
        summary.innerHTML = `<span class="badge accent">已配置 ${configuredCount}</span><span class="badge">候选 ${slotState.candidates.length}</span>`;
        panel.appendChild(summary);

        const hint = document.createElement('div');
        hint.className = 'slot-hint';
        hint.innerHTML = '请选择 slot 类型和数据类型，常用搭配：label + text / numericValue + unit / state / alert / listItem。';
        panel.appendChild(hint);

        const filterInput = document.createElement('input');
        filterInput.className = 'slot-filter';
        filterInput.placeholder = '筛选节点名称或文案（回车应用）';
        filterInput.value = slotFilter;
        filterInput.onchange = () => {
          slotFilter = filterInput.value.trim().toLowerCase();
          renderSlots();
        };
        panel.appendChild(filterInput);

        const grid = document.createElement('div');
        grid.className = 'slot-grid';

        const candidates = slotState.candidates
          .slice()
          .sort((a, b) => {
            const aSet = (slotState.slots || []).some((s) => s.nodeId === a.id);
            const bSet = (slotState.slots || []).some((s) => s.nodeId === b.id);
            if (aSet && !bSet) return -1;
            if (!aSet && bSet) return 1;
            return (a.name || '').localeCompare(b.name || '');
          })
          .filter((cand) => {
            if (!slotFilter) return true;
            const text = `${cand.name} ${cand.preview || ''}`.toLowerCase();
            return text.includes(slotFilter);
          });

        const rows = candidates.map((cand) => {
          const row = document.createElement('div');
          row.className = 'slot-row';
          row.style.display = 'contents';

          const label = document.createElement('div');
          label.textContent = `${cand.name} (${cand.type}) ${cand.preview ? '· ' + cand.preview : ''}`;

          const slotType = document.createElement('select');
          const emptyOpt = document.createElement('option');
          emptyOpt.value = '';
          emptyOpt.textContent = '不使用';
          slotType.appendChild(emptyOpt);
          SLOT_TYPES.forEach((st) => {
            const opt = document.createElement('option');
            opt.value = st;
            opt.textContent = st;
            slotType.appendChild(opt);
          });

          const dataTypeSelect = document.createElement('select');
          const emptyDt = document.createElement('option');
          emptyDt.value = '';
          emptyDt.textContent = '默认';
          dataTypeSelect.appendChild(emptyDt);
          DATA_TYPES.forEach((dt) => {
            const opt = document.createElement('option');
            opt.value = dt;
            opt.textContent = dt;
            dataTypeSelect.appendChild(opt);
          });

          const slotName = document.createElement('input');
          slotName.className = 'meta-input';
          slotName.placeholder = 'slot 名称';

          const existing = (slotState.slots || []).find((s) => s.nodeId === cand.id);
          if (existing) {
            slotType.value = existing.slotType || '';
            dataTypeSelect.value = existing.dataType || '';
            slotName.value = existing.slotName || cand.name;
          } else {
            slotName.value = cand.name;
          }

          row.appendChild(label);
          row.appendChild(slotType);
          row.appendChild(dataTypeSelect);
          row.appendChild(slotName);

          return { row, slotType, dataTypeSelect, slotName, cand };
        });

        rows.forEach((r) => {
          grid.appendChild(r.row);
        });
        panel.appendChild(grid);

        const actions = document.createElement('div');
        actions.className = 'row';
        actions.style.justifyContent = 'space-between';
        actions.style.marginTop = '8px';
        const resetBtn = document.createElement('button');
        resetBtn.textContent = '清空选择';
        resetBtn.onclick = () => {
          slotState.slots = [];
          renderSlots();
        };
        const saveBtn = document.createElement('button');
        saveBtn.textContent = '保存插槽';
        saveBtn.onclick = () => {
          const slots = rows
            .map((r) => {
              if (!r.slotType.value) return null;
              return {
                slotName: r.slotName.value || r.cand.name,
                nodeId: r.cand.id,
                slotType: r.slotType.value,
                dataType: r.dataTypeSelect.value || undefined
              };
            })
            .filter(Boolean);
          parent.postMessage(
            { pluginMessage: { type: 'save-slots', id: slotState.componentId, slots } },
            '*'
          );
          slotState.slots = slots;
          renderSlots();
        };
        actions.appendChild(resetBtn);
        actions.appendChild(saveBtn);
        panel.appendChild(actions);
      };
    </script>
  </body>
</html>
